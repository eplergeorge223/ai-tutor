<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255,255,255,0.1);
            --glass-border: rgba(255,255,255,0.2);
            --accent-green: linear-gradient(45deg, #4CAF50, #45a049);
            --accent-blue: linear-gradient(45deg, #2196F3, #1976D2);
            --accent-red: linear-gradient(45deg, #f44336, #d32f2f);
            --accent-yellow: linear-gradient(45deg, #ffcc00, #ffa500);
            --shadow-soft: 0 8px 32px rgba(0,0,0,0.12);
            --shadow-strong: 0 12px 40px rgba(0,0,0,0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --radius: 20px;
            --radius-sm: 15px;
            --radius-lg: 25px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 2rem;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(240,147,251,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container { text-align: center; max-width: 800px; width: 100%; }

        .mascot {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }

        h1, h2 {
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
              padding: 2rem;
  border-radius: var(--radius-lg);
        }

        .glass-panel:hover { transform: translateY(-2px); box-shadow: var(--shadow-strong); }

        .student-info {
            padding: 2rem;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            font-size: 1.1rem;
            margin-left: 0.5rem;
        }

        .form-group input, .form-group select {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 1rem 1.5rem;
            color: white;
            font-size: 1rem;
            width: 100%;
            max-width: 320px;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
        }

        .form-group input::placeholder { color: rgba(255,255,255,0.7); }
        .form-group select option { background: #764ba2; color: white; }

        .btn {
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before { left: 100%; }

        .btn-primary {
            background: var(--accent-green);
            padding: 1.5rem 3rem;
            font-size: 1.4rem;
            color: white;
            box-shadow: var(--shadow-soft);
            margin: 1rem 0;
        }

        

        .btn-primary:hover { transform: translateY(-3px); box-shadow: var(--shadow-strong); }

        .voice-button {
            background: var(--accent-blue);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 2rem;
            color: white;
            margin: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }

        .voice-button:hover { transform: scale(1.05); }
        .voice-button:active { transform: scale(0.95); }

        .voice-button.listening {
            background: var(--accent-red);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
        }

        .status {
            font-size: 1.2rem;
            margin: 2rem 0;
            min-height: 4rem;
            padding: 1.5rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .btn-secondary {
            background: var(--accent-red);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            color: white;
            margin: 0.5rem;
        }

        .btn-accent {
            background: var(--accent-yellow);
            color: #333;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            margin: 1rem auto;
            display: block;
        }

        .notes-section {
            padding: 1.5rem;
            margin: 2rem 0;
            max-width: 100%;
        }

        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .notes-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notes-tools {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .tool-btn {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.5rem;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover, .tool-btn.active {
            background: var(--glass-border);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-1px);
        }

        .notes-canvas-container {
            background: rgba(255,255,255,0.95);
            border-radius: var(--radius-sm);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            position: relative;
            min-height: 300px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: none;
            outline: none;
            background: transparent;
            resize: vertical;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            color: #333;
        }

        .notes-textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        .notes-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            touch-action: none;
        }

        .color-picker {
            display: flex;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .color-option:hover, .color-option.active {
            border-color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .brush-size {
            margin-left: 0.5rem;
        }

.brush-size {
    margin-left: 0.5rem;
    display: flex;
    align-items: center;
    min-width: 60px;
}

.brush-size input {
    width: 60px;
    max-width: 80px;
}

@media (max-width: 768px) {
    .notes-tools {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .brush-size {
        margin-left: 0;
        margin-top: 0.5rem;
        width: 100%;
        justify-content: center;
    }
    
    .brush-size input {
        width: 120px;
        max-width: 200px;
    }
}

@media (max-width: 480px) {
    .notes-header {
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    
    .brush-size input {
        width: 150px;
    }
}
/* Flag bad words in chat */
.bad-word {
  color: red;
  font-weight: bold;
}

        .voice-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .live-captions {
            position: fixed;
            bottom: 8vh;
            left: 50%;
            transform: translateX(-50%);
            min-width: 220px;
            max-width: 90vw;
            background: rgba(0,0,0,0.85);
            color: white;
            font-size: 1.3rem;
            font-weight: 500;
            padding: 1.2rem 2.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-strong);
            transition: var(--transition);
            pointer-events: none;
        }

        .live-captions.user-caption {
            background: rgba(76, 175, 80, 0.9);
            border: 2px solid #4CAF50;
        }

        .live-captions.bot-caption {
            background: rgba(33, 150, 243, 0.9);
            border: 2px solid #2196F3;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            color: #333;
            border-radius: var(--radius);
            padding: 2rem;
            width: 95vw;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-btn:hover { color: #f44336; transform: scale(1.1); }

        .chat-message {
            margin: 0.75rem 0;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .user-message {
            background: rgba(76, 175, 80, 0.15);
            margin-left: 1rem;
            border-left: 3px solid #4CAF50;
        }

        .tutor-message {
            background: rgba(33, 150, 243, 0.15);
            margin-right: 1rem;
            border-left: 3px solid #2196F3;
        }

        .session-summary {
            padding: 2rem;
            margin: 2rem 0;
            text-align: left;
        }

        .summary-item {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            border-left: 4px solid rgba(255,255,255,0.5);
        }

        .summary-item strong { color: rgba(255,255,255,0.9); }

        .reading-prompt {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .reading-word {
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 0.1em;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            color: #764ba2;
            padding: 1.5rem 3rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border: 3px solid rgba(255,255,255,0.8);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .hidden { display: none !important; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .suggestion-grid { grid-template-columns: 1fr; }
            .voice-controls { flex-direction: row; justify-content: center; }
            .container { padding: 0.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.6rem; }
            .voice-button { width: 100px; height: 100px; font-size: 1.5rem; }
            .btn-primary { padding: 1rem 2rem; font-size: 1.2rem; }
            .student-info { padding: 1.5rem; }
            .reading-word { font-size: 2.8rem; padding: 1rem 2rem; }
        }

        @media (max-width: 480px) {
            .mascot { font-size: 3rem; }
            .status { font-size: 1rem; padding: 1rem; }
            .live-captions { font-size: 1.1rem; padding: 1rem 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcome-screen">
            <div class="mascot">🎓</div>
            <h1>Hi! I'm your AI Tutor!</h1>
            <p style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9;">Ready to learn and explore together?</p>
            
            <div class="student-info glass-panel">
                <div class="form-group">
                    <label for="student-name">Student</label>
                    <input type="text" id="student-name" placeholder="What's your name?" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="student-grade">Grade</label>
                    <select id="student-grade">
                        <option value="">Select your grade</option>
                        <option value="PreK">Pre-K</option>
                        <option value="K">Kindergarten</option>
                        <option value="1">1st Grade</option>
                        <option value="2">2nd Grade</option>
                        <option value="3">3rd Grade</option>
                        <option value="4">4th Grade</option>
                        <option value="5">5th Grade</option>
                        <option value="6">6th Grade</option>
                        <option value="7">7th Grade</option>
                        <option value="8">8th Grade</option>
                        <option value="9">9th Grade</option>
                        <option value="10">10th Grade</option>
                        <option value="11">11th Grade</option>
                        <option value="12">12th Grade</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startTutoring()">Start Learning!</button>
        </div>

        <!-- Tutor Interface -->
        <div id="tutor-interface" class="hidden">
            <div class="mascot">🤖</div>
            <h2>Let's Learn Together!</h2>
            
            <div class="status glass-panel" id="status">Press the microphone to start talking!</div>
            
            <div class="voice-controls">
                <button class="voice-button btn" id="mic-btn" onclick="toggleListening()">🎤</button>
                <button class="btn btn-secondary" onclick="endSession()">End Session</button>
            </div>

            <div class="notes-section glass-panel">
                <div class="notes-header">
                    <div class="notes-title">📝 My Learning Notes</div>
                    <div class="notes-tools">
                        <button class="tool-btn" id="text-tool" onclick="switchToText()" title="Text Mode"> 📖 </button>
                        <button class="tool-btn active" id="draw-tool" onclick="switchToDraw()" title="Draw Mode"> 🖌️ </button>
                        <button class="tool-btn" onclick="clearNotes()" title="Clear All">🗑️</button>
                        <div class="color-picker">
                            <div class="color-option active" style="background: #000" onclick="setColor('#000')" data-color="#000"></div>
                            <div class="color-option" style="background: #e74c3c" onclick="setColor('#e74c3c')" data-color="#e74c3c"></div>
                            <div class="color-option" style="background: #3498db" onclick="setColor('#3498db')" data-color="#3498db"></div>
                            <div class="color-option" style="background: #2ecc71" onclick="setColor('#2ecc71')" data-color="#2ecc71"></div>
                            <div class="color-option" style="background: #f39c12" onclick="setColor('#f39c12')" data-color="#f39c12"></div>
                            <div class="color-option" style="background: #9b59b6" onclick="setColor('#9b59b6')" data-color="#9b59b6"></div>
                        </div>
                        <div class="brush-size">
                            <input type="range" id="brush-size" min="1" max="10" value="3" onchange="setBrushSize(this.value)">
                        </div>
                    </div>
                </div>
                <div class="notes-canvas-container">
                    <textarea class="notes-textarea" id="notes-text" placeholder="Type your learning notes here..." style="display: none;"></textarea>
                    <canvas class="notes-canvas" id="notes-canvas"></canvas>
                </div>
            </div>

        </div>

        <!-- Session Summary -->
        <div id="session-summary" class="session-summary glass-panel hidden">
            <h2>Session Complete! 🎉</h2>
            <div id="summary-content"></div>
            <button class="btn btn-primary" onclick="startNewSession()">Start New Session</button>
        </div>

        <!-- Live Captions -->
        <div id="live-captions" class="live-captions hidden" aria-live="polite"></div>

        <!-- Chat History Modal -->
        <div id="chat-history-modal" class="modal hidden">
            <div class="modal-content">
                <button onclick="closeHistory()" class="close-btn">&times;</button>
                <h3>Chat History</h3>
                <div id="full-chat-history"></div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            isListening: false,
            recognition: null,
            speechSynthesis: window.speechSynthesis,
            currentSessionId: null,
            isProcessing: false,
            sessionStarted: false,
            selectedVoice: null,
            conversationContext: [],
            chatHistory: [],
            currentSubject: null
        };

          let notesState = {
    isDrawing:   false,
    isTextMode:  false,
    currentColor:'#000',
    brushSize:   3,
    canvas:      null,
    ctx:         null
  };
        
        const API_BASE_URL = 'https://ai-tutor-ww9f.onrender.com/api';

        // Utility Functions
        const $ = id => document.getElementById(id);
        const updateStatus = msg => $('status').textContent = msg;
        const addToConversation = (sender, message) => state.chatHistory.push({ sender, message });
        const toggleClass = (element, className, condition) => element.classList.toggle(className, condition);

        // Speech Synthesis Setup
        async function initializeSpeechSynthesis() {
            return new Promise(resolve => {
                const selectVoice = () => {
                    const voices = state.speechSynthesis.getVoices();
                    const preferred = ['Samantha', 'Karen', 'Susan', 'Victoria', 'Google UK English Female', 'Microsoft Zira'];
                    
                    state.selectedVoice = preferred.map(name => 
                        voices.find(voice => voice.name.includes(name))
                    ).find(Boolean) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                    
                    resolve();
                };

                if (state.speechSynthesis.getVoices().length > 0) selectVoice();
                else {
                    state.speechSynthesis.onvoiceschanged = selectVoice;
                    setTimeout(selectVoice, 1000);
                }
            });
        }

function speakWithPromise(text) {
  return new Promise(resolve => {
    if (state.speechSynthesis.speaking) state.speechSynthesis.cancel();

    // grab the button once
    const micBtn = $('mic-btn');

    setTimeout(() => {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = state.selectedVoice;
      utterance.rate  = 0.8;
      utterance.pitch = 1.0;
      utterance.volume= 1.0;

      utterance.onstart = () => {
        // disable mic while AI speaks
        micBtn.disabled = true;
        showLiveCaption(text, 'bot');
      };

      utterance.onend = () => {
        $('live-captions').classList.add('hidden');
        micBtn.disabled = false;
        resolve();
      };

      utterance.onerror = () => {
        micBtn.disabled = false;
        resolve();
      };

      state.speechSynthesis.speak(utterance);
    }, 100);
  });
}


function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                updateStatus("Speech recognition not supported. Try Chrome or Edge!");
                return false;
            }

            try {
                state.recognition = new SpeechRecognition();
                Object.assign(state.recognition, {
                    continuous: false,
                    interimResults: true,
                    lang: 'en-US',
                    maxAlternatives: 1
                });

                // Add permission check for desktop
                if (!window.DeviceMotionEvent && navigator.permissions) {
                    navigator.permissions.query({name: 'microphone'}).then(result => {
                        if (result.state === 'denied') {
                            updateStatus("Microphone access denied. Please enable in browser settings.");
                        }
                    }).catch(() => {
                        console.log('Permission query not supported');
                    });
                }

                state.recognition.onstart = () => {
                    state.isListening = true;
                    updateMicButton();
                    updateStatus("I'm listening! Go ahead and speak.");
                };

                state.recognition.onend = () => {
                    state.isListening = false;
                    updateMicButton();
                    if (!state.isProcessing) updateStatus("Press the microphone to continue!");
                };

                state.recognition.onresult = event => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    
                    showLiveCaption(transcript, 'user');

                    if (event.results[event.results.length - 1].isFinal) {
                        if (transcript.trim() && !state.isProcessing) handleUserInput(transcript.trim());
                        else if (!state.isProcessing) updateStatus("I didn't catch that clearly. Please try again!");
                        
                        setTimeout(() => $('live-captions').classList.add('hidden'), 600);
                    }
                };

                state.recognition.onerror = event => {
                    state.isListening = false;
                    state.isProcessing = false;
                    updateMicButton();
                    
                    const errorMessages = {
                        'no-speech': "I didn't hear anything. Please try speaking closer.",
                        'audio-capture': "Couldn't access microphone. Check permissions.",
                        'not-allowed': "Microphone access denied. Enable in browser settings and refresh the page.",
                        'network': "Network error. Check internet connection.",
                        'service-not-allowed': "Speech service not allowed. Try refreshing the page."
                    };
                    
                    updateStatus(errorMessages[event.error] || `Speech error: ${event.error}. Please try again!`);
                    console.error('Speech recognition error:', event.error);
                };

                return true;
            } catch (error) {
                console.error('Failed to initialize speech recognition:', error);
                updateStatus("Failed to initialize microphone. Please refresh and try again.");
                return false;
            }
        }

        // Reading Word Display
        function showReadingWordPrompt(prompt, word) {
            const existing = $('reading-word-prompt');
            if (existing) existing.remove();

            const container = document.createElement('div');
            container.id = 'reading-word-prompt';
            container.className = 'reading-prompt';
            container.innerHTML = `
                <div style="font-size: 1.4rem; font-weight: 600;">${prompt}</div>
                <div class="reading-word">${word}</div>
            `;

            $('tutor-interface').insertBefore(container, $('tutor-interface').children[2]);
        }

        // Session Management
        async function startTutoring() {
            await initializeSpeechSynthesis();
            
            if (!initializeSpeechRecognition()) {
                alert('Speech recognition not supported. Use Chrome or Edge for best experience.');
                return;
            }

            const studentName = $('student-name').value.trim();
            const studentGrade = $('student-grade').value;

            try {
                updateStatus("Starting your session...");
                
                const response = await fetch(`${API_BASE_URL}/session/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentName: studentName || 'Student',
                        grade: studentGrade || 'K',
                        subjects: []
                    })
                });

                if (!response.ok) throw new Error('Failed to start session');

                const data = await response.json();
                state.currentSessionId = data.sessionId;
                state.sessionStarted = true;
                
                $('welcome-screen').classList.add('hidden');
                $('tutor-interface').classList.remove('hidden');
                
                // Initialize canvas after interface is shown
                setTimeout(() => initializeCanvas(), 100);
                
                const welcomeMessage = data.welcomeMessage || 
                    `Hi ${studentName || 'there'}! I'm your AI tutor and I'm excited to learn with you today. What would you like to explore?`;
                
                await speakWithPromise(welcomeMessage);
                addToConversation('tutor', welcomeMessage);
                updateStatus("Press the microphone to start talking!");

            } catch (error) {
                console.error('Error starting session:', error);
                alert("Failed to start session. Please try again later.");
            }
        }
async function handleUserInput(input) {
  if (state.isProcessing || !state.sessionStarted) return;

    // —— FLASH CARD OPT‑OUT HANDLER ——
  const cmd = input.trim().toLowerCase();
  if (cmd === 'stop showing flash cards') {
    state.flashCardsEnabled = false;
    // remove any card currently on screen
    const old = document.getElementById('reading-word-prompt');
    if (old) old.remove();
    updateStatus("Flash cards disabled.");
    // still let the tutor process the phrase if you want a verbal acknowledgement
  }


  state.isProcessing = true;
  updateStatus("Processing your request...");

  addToConversation('user', input);
  state.conversationContext.push({ role: 'user', content: input });

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);

    const response = await fetch(`${API_BASE_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId:    state.currentSessionId,
        userMessage:  input
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('API Error:', response.status, errorText);
      throw new Error(`API Error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    const tutorResponse = data.response;

    if (!tutorResponse.trim()) {
      throw new Error('Empty response from API');
    }

    // —— CONDITIONAL FLASH‑CARD RENDERING ——
    const shouldCard =  state.flashCardsEnabled &&
                        data.readingWord &&
                        (data.subject === 'reading' || data.subject === 'math');

    if (shouldCard) {
      showReadingWordPrompt(tutorResponse, data.readingWord);
    } else {
      // always clear old card if not showing a new one
      const old = document.getElementById('reading-word-prompt');
      if (old) old.remove();
    }

    // Now speak and record the tutor response (in both cases)
    await speakWithPromise(tutorResponse);
    addToConversation('tutor', tutorResponse);


    state.conversationContext.push({ role: 'assistant', content: tutorResponse });
    if (data.subject) state.currentSubject = data.subject;

  } catch (error) {
    console.error('Error getting response:', error);

    if (error.name === 'AbortError') {
      updateStatus("Request timed out. Please try again.");
      await speakWithPromise("Sorry, that took too long. Please try asking again.");
    } else {
      const fallback = generateEnhancedFallbackResponse(input);
      addToConversation('tutor', fallback);
      await speakWithPromise(fallback);
    }
  } finally {
    state.isProcessing = false;
    updateStatus("Press the microphone to continue our conversation!");
  }
}


        function initializeCanvas() {
    const canvas    = document.getElementById('notes-canvas');
    const container = canvas.parentElement;
    canvas.width    = container.clientWidth;
    canvas.height   = Math.max(300, container.clientHeight);

    notesState.canvas = canvas;
    notesState.ctx    = canvas.getContext('2d');
            
            // Set up drawing events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            if (notesState.isTextMode) return;
            
            notesState.isDrawing = true;
            const rect = notesState.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            notesState.ctx.beginPath();
            notesState.ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!notesState.isDrawing || notesState.isTextMode) return;
            
            const rect = notesState.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            notesState.ctx.lineWidth = notesState.brushSize;
            notesState.ctx.lineCap = 'round';
            notesState.ctx.strokeStyle = notesState.currentColor;
            
            notesState.ctx.lineTo(x, y);
            notesState.ctx.stroke();
            notesState.ctx.beginPath();
            notesState.ctx.moveTo(x, y);
        }

        function stopDrawing() {
            notesState.isDrawing = false;
            notesState.ctx.beginPath();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            notesState.canvas.dispatchEvent(mouseEvent);
        }

        function switchToText() {
            notesState.isTextMode = true;
            $('text-tool').classList.add('active');
            $('draw-tool').classList.remove('active');
            $('notes-text').style.display = 'block';
            $('notes-canvas').style.display = 'none';
        }

        function switchToDraw() {
            notesState.isTextMode = false;
            $('draw-tool').classList.add('active');
            $('text-tool').classList.remove('active');
            $('notes-text').style.display = 'none';
            $('notes-canvas').style.display = 'block';
            if (!notesState.canvas) initializeCanvas();
        }

        function setColor(color) {
            notesState.currentColor = color;
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function setBrushSize(size) {
            notesState.brushSize = parseInt(size);
        }

        function clearNotes() {
            if (notesState.isTextMode) {
                $('notes-text').value = '';
            } else {
                if (notesState.ctx) {
                    notesState.ctx.clearRect(0, 0, notesState.canvas.width, notesState.canvas.height);
                }
            }
        }

function generateFallbackResponse(input) {
            const responses = {
                math: "I love math! Let's work on this together. What would you like to practice?",
                read: "Reading is so much fun! What kind of stories do you enjoy?",
                animal: "Animals are amazing! Do you have a favorite animal?"
            };
            
            const key = Object.keys(responses).find(k => input.toLowerCase().includes(k));
            return responses[key] || "That sounds interesting! Can you tell me more about what you're thinking?";
        }

        function generateEnhancedFallbackResponse(input) {
            const inputLower = input.toLowerCase();
            
            const subjectResponses = {
                math: [
                    "Math is exciting! What type of math problem would you like to work on?",
                    "I love helping with math! Are you working on addition, subtraction, or something else?",
                    "Numbers are fun! What math topic interests you most?"
                ],
                read: [
                    "Reading opens up amazing worlds! What kind of books do you enjoy?",
                    "I love talking about reading! Do you have a favorite story?",
                    "Books are wonderful! What would you like to read about?"
                ],
                science: [
                    "Science is all around us! What scientific topic are you curious about?",
                    "I love exploring science! Are you interested in animals, space, or experiments?",
                    "Science is amazing! What would you like to discover today?"
                ],
                history: [
                    "History tells incredible stories! What time period interests you?",
                    "The past is full of fascinating people and events! What would you like to learn about?",
                    "History is like a treasure hunt for knowledge! What historical topic excites you?"
                ]
            };
            
            const matchedSubject = Object.keys(subjectResponses).find(subject => 
                inputLower.includes(subject)
            );
            
            if (matchedSubject) {
                const responses = subjectResponses[matchedSubject];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            const generalResponses = [
                "That's a great question! I'm having trouble connecting right now, but I'd love to explore that topic with you. Can you tell me more?",
                "I'm excited to learn about that with you! While I sort out a technical issue, could you share what interests you most about this?",
                "Your curiosity is wonderful! I'm experiencing some connection issues, but let's keep the conversation going. What would you like to discover?",
                "I love your enthusiasm for learning! There seems to be a small technical hiccup, but I'm still here to help. What else can you tell me about this topic?"
            ];
            
            return generalResponses[Math.floor(Math.random() * generalResponses.length)];
        }
function toggleListening() {
  if (!state.recognition) {
    updateStatus("Speech recognition not available!");
    return;
  }
  if (state.isProcessing) {
    updateStatus("Please wait, processing your message...");
    return;
  }

  if (state.isListening) {
    // stop if we’re already listening
    try {
      state.recognition.stop();
    } catch (e) {
      console.error('Error stopping recognition:', e);
    }
  } else {
    // 🔥 fire it off directly—no setTimeout
    try {
      state.recognition.start();
    } catch (e) {
      console.error('Error starting microphone:', e);
      updateStatus("Error starting microphone. Please check permissions and try again.");
    }
  }
}

        function updateMicButton() {
            const micBtn = $('mic-btn');
            micBtn.classList.toggle('listening', state.isListening);
            micBtn.innerHTML = state.isListening ? '🔴' : '🎤';
        }

let lastCaptionTime = 0;
function showLiveCaption(text, type = 'bot') {
  const now = Date.now();
  if (now - lastCaptionTime < 200) return; 
  lastCaptionTime = now;
  const captionsDiv = $('live-captions');
  captionsDiv.textContent = text;
  captionsDiv.className = `live-captions ${type}-caption`;
  captionsDiv.classList.remove('hidden');
}


        async function speakSuggestion(suggestion) {
            if (!state.isProcessing && !state.isListening) handleUserInput(suggestion);
        }

        // History and Session Management
        function showHistory() {
            $('full-chat-history').innerHTML = state.chatHistory.map(msg =>
                `<div class="chat-message ${msg.sender}-message">
                    <strong>${msg.sender === 'tutor' ? 'Tutor' : 'You'}:</strong> ${msg.message}
                </div>`
            ).join('');
            $('chat-history-modal').classList.remove('hidden');
        }

        function closeHistory() {
            $('chat-history-modal').classList.add('hidden');
        }

        async function endSession() {
            state.speechSynthesis.cancel();
            if (state.isListening) state.recognition.stop();
            
            try {
                const response = await fetch(`${API_BASE_URL}/session/${state.currentSessionId}/summary`);
                await fetch(`${API_BASE_URL}/session/${state.currentSessionId}/end`, { method: 'POST' });
                const summary = response.ok ? await response.json() : null;
                showSessionSummary(summary);
            } catch (error) {
                console.error('Error getting summary:', error);
                showSessionSummary(null);
            }
        }

        async function showSessionSummary(summary) {
            $('tutor-interface').classList.add('hidden');
            $('session-summary').classList.remove('hidden');
            
            const summaryContent = $('summary-content');
            
            if (summary) {
                const allSuggestions = [
                    ...(Array.isArray(summary.suggestions) ? summary.suggestions : [summary.suggestions]),
                    ...(Array.isArray(summary.nextSteps) ? summary.nextSteps : [summary.nextSteps])
                ].filter(Boolean);

                summaryContent.innerHTML = `
                    <div class="summary-item"><strong>Duration:</strong> ${summary.duration}</div>
                    <div class="summary-item"><strong>Off-topic Requests:</strong> ${summary.totalWarnings}</div>
                    <div class="summary-item"><strong>Topics Explored:</strong> ${summary.topicsExplored}</div>
                    <div class="summary-item"><strong>Learning Highlights:</strong><br>${summary.highlights.join('<br>')}</div>
                    <div class="summary-item"><strong>Next Steps:</strong><br>${allSuggestions.length ? allSuggestions.join('<br>') : 'Keep asking great questions!'}</div>
                `;
            } else {
                summaryContent.innerHTML = `
                    <div class="summary-item"><strong>Session Complete!</strong> You had a wonderful learning session today!</div>
                    <div class="summary-item"><strong>Keep Learning:</strong> Continue exploring topics that spark your curiosity!</div>
                `;
            }
            
            await speakWithPromise("You had a wonderful learning session today! Keep being curious and asking great questions.");
        }

        function startNewSession() {
            state.speechSynthesis.cancel();
            Object.assign(state, {
                currentSessionId: null,
                isProcessing: false,
                sessionStarted: false,
                isListening: false,
                conversationContext: [],
                chatHistory: [],
   currentSubject: null,
  flashCardsEnabled: true    // ← NEW: toggle this to enable/disable flash cards

            });
            
            $('session-summary').classList.add('hidden');
            $('welcome-screen').classList.remove('hidden');
            $('student-name').value = '';
            $('student-grade').value = '';
            
            updateMicButton();
            updateStatus("Ready to start a new session!");
        }

        // Initialize App
        window.onload = async function() {
            console.log('🚀 AI Tutor loading...');
            await initializeSpeechSynthesis();
            console.log('✅ App loaded successfully');
        };
        // Pause mic when tab/window loses focus
window.addEventListener('blur', () => {
  if (state.isListening) state.recognition.stop();
});
// Optionally restart recognition when they return
window.addEventListener('focus', () => {
  updateStatus("Press the microphone to continue our conversation!");
});

    </script>
</body>
</html>