<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #5A67D8;
            --color-secondary: #ED8936;
            --color-accent: #ECC94B;
            --color-success: #48BB78;
            --color-success-500: #10B981;
            --color-danger: #F56565;
            --color-background: #F7FAFC;
            --color-text: #2D3748;
            --color-gray-100: #EDF2F7;
            --color-gray-200: #E2E8F0;
            --color-gray-300: #CBD5E0;
            --color-gray-500: #A0AEC0;
            --color-gray-600: #718096;
            --color-white: #FFFFFF;
        }

        /* General body and container styling to prevent scrolling */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            height: 100%;
            overflow: hidden; /* This is the key change to prevent scrolling */
        }

        /* Make sure all main pages fit the screen */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: auto; /* Allow content inside the page to scroll if needed, but not the page itself */
        }

        .page.active {
            display: flex;
        }

        /* Welcome page */
        #welcomePage {
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 2rem;
            box-sizing: border-box;
        }
        
        .welcome-content {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        
        .welcome-content h1 {
            font-size: 2.5rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }
        
        .welcome-content p {
            color: var(--color-gray-600);
            margin-bottom: 2rem;
        }

        #setupForm {
            background-color: var(--color-white);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .form-group {
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--color-text);
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--color-gray-200);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        
        .grade-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        
        .grade-btn {
            padding: 0.75rem;
            border: 2px solid var(--color-gray-200);
            border-radius: 0.75rem;
            background-color: var(--color-gray-100);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .grade-btn:hover {
            border-color: var(--color-primary);
            background-color: var(--color-gray-200);
        }
        
        .grade-btn.selected {
            background-color: var(--color-primary);
            color: var(--color-white);
            border-color: var(--color-primary);
        }
        
        #startBtn {
            padding: 1rem;
            background-color: var(--color-primary);
            color: var(--color-white);
            border: none;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.5;
        }
        
        #startBtn:disabled {
            cursor: not-allowed;
        }
        
        #startBtn:hover:not(:disabled) {
            background-color: #4c5bbd;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            border-right-color: var(--color-white);
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Main Interface */
        #mainInterface {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--color-white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info h2 {
            font-size: 1.25rem;
            margin: 0;
            color: var(--color-primary);
        }

        .user-info p {
            font-size: 0.875rem;
            margin: 0;
            color: var(--color-gray-600);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            background-color: var(--color-gray-300);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .timer {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-gray-600);
            background-color: var(--color-gray-100);
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
        }

        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        
        .control-btn:hover {
            background-color: var(--color-gray-100);
        }
        
        .control-btn svg {
            width: 24px;
            height: 24px;
            color: var(--color-gray-600);
        }

        .main-content {
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .ai-mascot {
            text-align: center;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .mascot-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--color-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .mascot-message {
            background-color: var(--color-white);
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            position: relative;
            font-weight: 600;
            color: var(--color-text);
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mascot-message::before {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 20px;
            height: 20px;
            background-color: var(--color-white);
        }

        .card-container {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            overflow-x: auto;
            width: 100%;
        }

        .word-card {
            background: var(--color-primary);
            color: var(--color-white);
            border-radius: 1.5rem;
            width: 250px;
            height: 150px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            perspective: 1000px;
            cursor: pointer;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .word-card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            box-sizing: border-box;
            border-radius: 1.5rem;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .card-front .card-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .card-front .card-title {
            font-size: 1.5rem;
            margin: 0;
        }

        .card-back .card-description {
            margin: 0;
            font-size: 1rem;
            text-align: center;
        }
        
        .chat-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--color-white);
            border-radius: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-history {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .chat-caption {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .chat-caption .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .chat-caption.user .avatar {
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        
        .chat-caption.ai .avatar {
            background-color: var(--color-secondary);
            color: var(--color-white);
        }
        
        .caption-text {
            background-color: var(--color-gray-100);
            padding: 1rem;
            border-radius: 1rem;
            max-width: 80%;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .chat-caption.ai .caption-text {
            border-top-left-radius: 0;
        }
        
        .chat-caption.user .caption-text {
            border-top-right-radius: 0;
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        
        .chat-input {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--color-gray-200);
            background-color: var(--color-white);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .microphone-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid var(--color-gray-200);
            background-color: var(--color-gray-100);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .microphone-button svg {
            width: 30px;
            height: 30px;
            color: var(--color-gray-600);
            position: absolute;
            z-index: 2;
        }

        .microphone-button.mic-listening {
            border-color: var(--color-accent);
            background-color: var(--color-accent);
            transform: scale(1.1);
        }
        
        .microphone-button.mic-listening svg {
            color: var(--color-white);
            animation: pulse 1s infinite;
        }

        .microphone-button.mic-processing {
            border-color: var(--color-secondary);
            background-color: var(--color-secondary);
            transform: scale(1.1);
        }

        .microphone-button.mic-processing svg {
            color: var(--color-white);
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 201, 75, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(236, 201, 75, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 201, 75, 0); }
        }

        .voice-instructions {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--color-gray-500);
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
        }
        
        .footer {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--color-gray-200);
            background-color: var(--color-white);
        }

        .status {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: var(--color-gray-600);
        }

        .notes-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 500px;
            height: 100%;
            background-color: var(--color-white);
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease-in-out;
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        
        .notes-panel.open {
            right: 0;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .notes-header h3 {
            margin: 0;
        }

        .notes-body {
            flex-grow: 1;
            padding: 1rem;
            position: relative;
        }
        
        #notesTextarea, #drawingCanvas {
            width: 100%;
            height: 100%;
            border: 2px solid var(--color-gray-200);
            border-radius: 1rem;
            padding: 1rem;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            resize: none;
        }
        
        #drawingCanvas {
            cursor: crosshair;
        }
        
        .notes-controls {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .notes-mode-switcher {
            display: flex;
            gap: 0.5rem;
        }
        
        .notes-mode-btn {
            flex-grow: 1;
            padding: 0.75rem;
            background-color: var(--color-gray-100);
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        .notes-mode-btn.active {
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        
        .drawing-tools {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .color-options {
            display: flex;
            gap: 0.5rem;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }
        
        .color-option.selected {
            border-color: var(--color-primary);
            transform: scale(1.1);
        }

        .brush-size-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .brush-size-control input[type="range"] {
            flex-grow: 1;
        }

        /* Summary Page */
        #summaryPage {
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .summary-card {
            background-color: var(--color-white);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            max-width: 600px;
            width: 100%;
            text-align: left;
        }
        
        .summary-card h2 {
            font-size: 2rem;
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }
        
        .summary-card p {
            color: var(--color-gray-600);
            margin-bottom: 1.5rem;
        }
        
        .summary-details {
            border-top: 1px solid var(--color-gray-200);
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }
        
        .summary-details h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .summary-details ul {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .summary-details ul li {
            background-color: var(--color-gray-100);
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
        }

        .summary-details ul li strong {
            display: block;
            font-size: 0.8rem;
            color: var(--color-gray-500);
            font-weight: 400;
        }
        
        .summary-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .summary-buttons button {
            flex-grow: 1;
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #newSessionBtn {
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        
        #newSessionBtn:hover {
            background-color: #4c5bbd;
        }
        
        #shareProgressBtn {
            background-color: var(--color-gray-200);
            color: var(--color-text);
        }
        
        #shareProgressBtn:hover {
            background-color: var(--color-gray-300);
        }
        
        #viewProgressBtn {
            background-color: var(--color-secondary);
            color: var(--color-white);
        }
        
        #viewProgressBtn:hover {
            background-color: #d67a2a;
        }

        /* Notification */
        #notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--color-success-500);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .summary-details ul {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div id="welcomePage" class="page active">
        <div class="welcome-content">
            <h1>Hi there! What's your name?</h1>
            <p>I'm your AI Tutor. Let's get to know each other before we start learning!</p>
            <form id="setupForm">
                <div class="form-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="Type your name here..." required>
                </div>
                <div class="form-group">
                    <label>Grade Level</label>
                    <div class="grade-selection">
                        <button type="button" class="grade-btn" data-grade="K">K</button>
                        <button type="button" class="grade-btn" data-grade="1">1</button>
                        <button type="button" class="grade-btn" data-grade="2">2</button>
                        <button type="button" class="grade-btn" data-grade="3">3</button>
                        <button type="button" class="grade-btn" data-grade="4">4</button>
                        <button type="button" class="grade-btn" data-grade="5">5</button>
                    </div>
                    <input type="hidden" id="selectedGrade" required>
                </div>
                <button type="submit" id="startBtn" disabled>Start your session!</button>
            </form>
        </div>
    </div>

    <div id="mainInterface" class="page">
        <header class="header">
            <div class="header-left">
                <div class="user-info">
                    <h2 id="displayStudentName">Student</h2>
                    <p id="displayStudentGrade">K Grade</p>
                </div>
            </div>
            <div class="header-right">
                <div class="timer" id="sessionTimer">00:00</div>
                <button class="control-btn" id="notesToggleBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 4h7v5h5v11H6zM13 19h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2z"/></svg>
                </button>
                <button class="control-btn" id="endSessionBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm-2-2v4h4v-4H9zM15 14h-2v-4h2v4z"/></svg>
                </button>
            </div>
        </header>

        <section class="main-content">
            <div class="ai-mascot">
                <img src="/public/mascot.svg" alt="AI Tutor Mascot" class="mascot-image">
                <p class="mascot-message" id="mascotMessage">Hi there! How can I help you learn today?</p>
            </div>

            <div id="dynamicWordCard" class="card-container"></div>
            
            <div class="chat-container">
                <div class="chat-history" id="chatHistory">
                    <div class="chat-caption ai">
                        <div class="avatar">AI</div>
                        <div class="caption-text">Hello! I am your AI tutor. I can help you with a variety of subjects. What would you like to learn today?</div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <div class="status">
                <span id="statusDot" class="status-dot"></span>
                <span id="statusText">Ready to learn</span>
            </div>
            <div class="chat-input">
                <button class="microphone-button" id="microphoneBtn">
                    <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
                <div id="voiceInstructions" class="voice-instructions">Tap the microphone and start speaking</div>
                <button class="control-btn" id="readAloudBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 2v20h2v-2H4V4h16v16h-2v-2h2V4H4zm10 8h2c1.1 0 2 .9 2 2v2c0 1.1-.9 2-2 2h-2c-1.1 0-2-.9-2-2v-2c0-1.1.9-2 2-2zm0 2v2h2v-2h-2z"/></svg>
                </button>
            </div>
        </footer>
    </div>

    <div id="summaryPage" class="page">
        <div class="summary-card">
            <h2>Session Summary</h2>
            <p>Here's a quick look at your recent learning session.</p>
            <div class="summary-details">
                <h3>Details</h3>
                <ul>
                    <li><strong>Student Name</strong> <span id="summaryStudentName"></span></li>
                    <li><strong>Session Date</strong> <span id="sessionDate"></span></li>
                    <li><strong>Session Duration</strong> <span id="sessionDuration"></span></li>
                    <li><strong>Topics Covered</strong> <span id="topicsCovered">Math, Science</span></li>
                </ul>
            </div>
            <div class="summary-buttons">
                <button id="newSessionBtn">Start a New Session</button>
                <button id="shareProgressBtn">Share Progress</button>
                <button id="viewProgressBtn">View All Progress</button>
            </div>
        </div>
    </div>

    <div id="notesPanel" class="notes-panel">
        <div class="notes-header">
            <h3>Your Notes</h3>
            <div class="notes-header-controls">
                <button class="control-btn" id="saveNotesBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                </button>
                <button class="control-btn" id="closeNotesBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
        </div>
        <div class="notes-body">
            <div id="textMode">
                <textarea id="notesTextarea" placeholder="Write your notes here..."></textarea>
            </div>
            <div id="drawMode" style="display: none;">
                <canvas id="drawingCanvas"></canvas>
            </div>
        </div>
        <div class="notes-controls">
            <div class="notes-mode-switcher">
                <button id="textModeBtn" class="notes-mode-btn active">Text</button>
                <button id="drawModeBtn" class="notes-mode-btn">Draw</button>
            </div>
            <div id="drawingTools" class="drawing-tools" style="display: none;">
                <div class="color-options">
                    <span class="color-option selected" data-color="#000000" style="background-color: #000000;"></span>
                    <span class="color-option" data-color="#F56565" style="background-color: #F56565;"></span>
                    <span class="color-option" data-color="#48BB78" style="background-color: #48BB78;"></span>
                    <span class="color-option" data-color="#ECC94B" style="background-color: #ECC94B;"></span>
                    <span class="color-option" data-color="#5A67D8" style="background-color: #5A67D8;"></span>
                </div>
                <div class="brush-size-control">
                    <span>Brush Size:</span>
                    <input type="range" id="brushSize" min="1" max="20" value="5">
                    <span id="brushSizeValue">5px</span>
                    <button class="control-btn" id="clearCanvasBtn">Clear</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification"></div>

    <script>
        class AITutorApp {
            constructor() {
                this.currentPage = 'welcomePage';
                this.studentData = { name: '', grade: '', sessionStartTime: null };
                this.sessionTimer = null;
                this.sessionDuration = 0;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.isListening = false;
                this.isProcessing = false;
                this.drawingState = {
                    isDrawing: false,
                    currentColor: '#000000',
                    currentSize: 5,
                    lastX: 0,
                    lastY: 0
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializeSpeechRecognition();
                this.loadSavedData();
                this.updateDisplay();
            }

            setupEventListeners() {
                // Welcome Page
                const setupForm = document.getElementById('setupForm');
                setupForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
                document.getElementById('studentName').addEventListener('input', () => this.validateForm());
                document.querySelectorAll('.grade-btn').forEach(button => button.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    document.getElementById('selectedGrade').value = button.dataset.grade;
                    this.validateForm();
                }));

                // Main Interface
                document.getElementById('microphoneBtn').addEventListener('click', () => this.toggleVoiceRecognition());
                document.getElementById('notesToggleBtn').addEventListener('click', () => this.openNotesPanel());
                document.getElementById('endSessionBtn').addEventListener('click', () => this.endSession());
                document.getElementById('readAloudBtn').addEventListener('click', () => this.readAloud());

                // Notes Panel
                document.getElementById('closeNotesBtn').addEventListener('click', () => this.closeNotesPanel());
                document.getElementById('textModeBtn').addEventListener('click', () => this.switchNotesMode('text'));
                document.getElementById('drawModeBtn').addEventListener('click', () => this.switchNotesMode('draw'));
                let saveTimeout;
                document.getElementById('notesTextarea').addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => this.saveNotes(true), 1000);
                });
                document.getElementById('saveNotesBtn').addEventListener('click', () => this.saveNotes());

                // Drawing Canvas
                const canvas = document.getElementById('drawingCanvas');
                if (canvas) {
                    this.drawingCanvas = canvas;
                    this.drawingContext = canvas.getContext('2d');
                    this.setupDrawingEvents(canvas);
                }

                // Summary Page
                document.getElementById('newSessionBtn').addEventListener('click', () => this.startNewSession());
                document.getElementById('shareProgressBtn').addEventListener('click', () => this.shareProgress());
                document.getElementById('viewProgressBtn').addEventListener('click', () => this.viewAllProgress());

                // Global Events
                document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
                window.addEventListener('resize', () => this.handleWindowResize());
            }

            handleFormSubmit(e) {
                e.preventDefault();
                const name = document.getElementById('studentName').value.trim();
                const grade = document.getElementById('selectedGrade').value;
                if (name && grade) {
                    this.studentData.name = name;
                    this.studentData.grade = grade;
                    this.studentData.sessionStartTime = new Date();
                    this.saveStudentData();
                    this.showLoadingAndTransition();
                }
            }

            validateForm() {
                const name = document.getElementById('studentName').value.trim();
                const grade = document.getElementById('selectedGrade').value;
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = !(name && grade);
                startBtn.style.opacity = name && grade ? '1' : '0.5';
            }

            showLoadingAndTransition() {
                const startBtn = document.getElementById('startBtn');
                startBtn.innerHTML = `<span style="position: relative; z-index: 10; display: flex; align-items: center; justify-content: center;"><div class="loading-spinner"></div>Preparing your session...</span>`;
                setTimeout(() => {
                    this.switchToPage('mainInterface');
                    this.startSessionTimer();
                }, 2000);
            }

            switchToPage(pageId) {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                this.currentPage = pageId;
                this.updateDisplay();
            }

            updateDisplay() {
                if (this.currentPage === 'mainInterface') {
                    document.getElementById('displayStudentName').textContent = this.studentData.name || 'Student';
                    document.getElementById('displayStudentGrade').textContent = (this.studentData.grade || 'K') + ' Grade';
                } else if (this.currentPage === 'summaryPage') {
                    document.getElementById('summaryStudentName').textContent = this.studentData.name || 'Student';
                    document.getElementById('sessionDate').textContent = `Session completed on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`;
                    const duration = Math.floor(this.sessionDuration / 60);
                    document.getElementById('sessionDuration').textContent = `${duration} min`;
                }
            }
            
            startSessionTimer() {
                this.sessionTimer = setInterval(() => {
                    this.sessionDuration++;
                    const minutes = Math.floor(this.sessionDuration / 60);
                    const seconds = this.sessionDuration % 60;
                    document.getElementById('sessionTimer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            stopSessionTimer() {
                if (this.sessionTimer) {
                    clearInterval(this.sessionTimer);
                    this.sessionTimer = null;
                }
            }

            toggleVoiceRecognition() {
                if (!this.recognition) {
                    alert('Speech recognition is not supported in your browser.');
                    return;
                }
                if (this.isListening) {
                    this.recognition.stop();
                } else if (!this.isProcessing) {
                    this.recognition.start();
                }
            }

            initializeSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.lang = 'en-US';
                    this.recognition.interimResults = false;
                    this.recognition.maxAlternatives = 1;

                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.updateMicrophoneState('listening');
                        this.updateStatus('listening', 'Listening...');
                    };

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.addCaption('user', transcript);
                        this.processUserInput(transcript);
                    };

                    this.recognition.onend = () => {
                        this.isListening = false;
                        if (!this.isProcessing) {
                            this.updateMicrophoneState('idle');
                            this.updateStatus('ready', 'Ready to learn');
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.updateMicrophoneState('idle');
                        this.updateStatus('error', `Error: ${event.error}`);
                        this.showMascotMessage('Sorry, I couldn\'t hear you. Can you please repeat that?');
                        this.isListening = false;
                        this.isProcessing = false;
                    };
                }
            }
            
            processUserInput(input) {
                this.isProcessing = true;
                this.updateMicrophoneState('processing');
                this.updateStatus('processing', 'Processing...');

                // Simulate AI processing delay
                setTimeout(() => {
                    const response = this.generateAIResponse(input);
                    this.addCaption('ai', response);
                    this.speakResponse(response);
                    
                    // This is where you can add your logic to show/hide the flashcard
                    const showCard = input.toLowerCase().includes('math') || input.toLowerCase().includes('vocabulary');
                    this.updateFlashcard(showCard, 'Word', 'Definition'); // Example usage

                    this.isProcessing = false;
                    this.updateMicrophoneState('idle');
                    this.updateStatus('ready', 'Ready to learn');
                    this.showMascotMessage(this.getRandomEncouragement());
                }, 1500);
            }
            
            generateAIResponse(input) {
                const lowerInput = input.toLowerCase();
                if (lowerInput.includes('hello') || lowerInput.includes('hi')) {
                    return `Hello ${this.studentData.name}! How can I help you today?`;
                } else if (lowerInput.includes('how are you')) {
                    return 'I am doing great, thank you! I\'m ready to help you learn.';
                } else if (lowerInput.includes('what is')) {
                    const topic = input.split('what is')[1] || 'something';
                    return `That's a great question! Let's explore what ${topic.trim()} is.`;
                } else {
                    return `That's an interesting thought! Let's dive deeper into that.`;
                }
            }
            
            speakResponse(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                this.synthesis.speak(utterance);
            }
            
            addCaption(speaker, text) {
                const chatHistory = document.getElementById('chatHistory');
                const newCaption = document.createElement('div');
                newCaption.classList.add('chat-caption', speaker);
                
                const avatar = document.createElement('div');
                avatar.classList.add('avatar');
                avatar.textContent = speaker.toUpperCase();
                
                const captionText = document.createElement('div');
                captionText.classList.add('caption-text');
                captionText.textContent = text;
                
                newCaption.appendChild(avatar);
                newCaption.appendChild(captionText);
                chatHistory.appendChild(newCaption);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            updateMicrophoneState(state) {
                const microphoneBtn = document.getElementById('microphoneBtn');
                const voiceInstructions = document.getElementById('voiceInstructions');
                const micIcon = document.getElementById('micIcon');
                
                microphoneBtn.className = `microphone-button mic-${state}`;
                
                if (state === 'listening') {
                    voiceInstructions.textContent = 'Listening... Speak now!';
                    micIcon.innerHTML = `<path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>`;
                } else if (state === 'processing') {
                    voiceInstructions.textContent = 'Processing your response...';
                    micIcon.innerHTML = `<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>`;
                } else {
                    voiceInstructions.textContent = 'Tap the microphone and start speaking';
                    micIcon.innerHTML = `<path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>`;
                }
            }

            updateStatus(type, message) {
                const statusText = document.getElementById('statusText');
                const statusDot = document.getElementById('statusDot');
                statusText.textContent = message;
                statusDot.className = 'status-dot';
                switch (type) {
                    case 'listening': statusDot.style.background = 'var(--color-accent)'; break;
                    case 'processing': statusDot.style.background = 'var(--color-secondary)'; break;
                    case 'error': statusDot.style.background = 'var(--color-danger)'; break;
                    default: statusDot.style.background = 'var(--color-success)'; break;
                }
            }

            showMascotMessage(message) {
                const mascotMessage = document.getElementById('mascotMessage');
                mascotMessage.textContent = message;
            }

            getRandomEncouragement() {
                const messages = [
                    "You're doing great!",
                    "Keep up the good work!",
                    "That's a fantastic question!",
                    "I'm here to help you shine!",
                    "Learning is fun, isn't it?"
                ];
                return messages[Math.floor(Math.random() * messages.length)];
            }
            
            readAloud() {
                const chatHistory = document.getElementById('chatHistory');
                const lastAICaption = chatHistory.querySelector('.chat-caption.ai:last-child .caption-text');
                if (lastAICaption) {
                    this.speakResponse(lastAICaption.textContent);
                    this.showMascotMessage('Reading the last message out loud!');
                } else {
                    this.showMascotMessage('There are no messages to read out loud yet.');
                }
            }

            openNotesPanel() {
                document.getElementById('notesPanel').classList.add('open');
                this.resizeCanvas();
            }

            closeNotesPanel() {
                document.getElementById('notesPanel').classList.remove('open');
            }

            switchNotesMode(mode) {
                document.getElementById('textModeBtn').classList.toggle('active', mode === 'text');
                document.getElementById('drawModeBtn').classList.toggle('active', mode === 'draw');
                document.getElementById('textMode').style.display = mode === 'text' ? 'block' : 'none';
                document.getElementById('drawMode').style.display = mode === 'draw' ? 'block' : 'none';
                document.getElementById('drawingTools').style.display = mode === 'draw' ? 'flex' : 'none';
                if (mode === 'draw') {
                    this.resizeCanvas();
                }
            }

            resizeCanvas() {
                if (this.drawingCanvas) {
                    const parent = this.drawingCanvas.parentElement;
                    const dataUrl = this.drawingCanvas.toDataURL();
                    this.drawingCanvas.width = parent.clientWidth;
                    this.drawingCanvas.height = parent.clientHeight;
                    if (dataUrl) {
                        const img = new Image();
                        img.onload = () => { this.drawingContext.drawImage(img, 0, 0); };
                        img.src = dataUrl;
                    }
                }
            }
            
            setupDrawingEvents(canvas) {
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;

                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.drawingState.currentColor = option.dataset.color;
                    });
                });
                
                const brushSize = document.getElementById('brushSize');
                const brushSizeValue = document.getElementById('brushSizeValue');
                brushSize.addEventListener('input', () => {
                    this.drawingState.currentSize = brushSize.value;
                    brushSizeValue.textContent = brushSize.value + 'px';
                });

                canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                canvas.addEventListener('mousemove', (e) => this.draw(e));
                canvas.addEventListener('mouseup', () => this.stopDrawing());
                canvas.addEventListener('mouseout', () => this.stopDrawing());
                canvas.addEventListener('touchstart', (e) => this.handleTouchEvent(e, 'mousedown'));
                canvas.addEventListener('touchmove', (e) => this.handleTouchEvent(e, 'mousemove'));
                canvas.addEventListener('touchend', (e) => this.handleTouchEvent(e, 'mouseup'));
                
                document.getElementById('clearCanvasBtn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear the canvas?')) {
                        this.drawingContext.clearRect(0, 0, canvas.width, canvas.height);
                    }
                });
            }

            handleTouchEvent(e, type) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(type, { clientX: touch.clientX, clientY: touch.clientY });
                this.drawingCanvas.dispatchEvent(mouseEvent);
            }

            startDrawing(e) {
                this.drawingState.isDrawing = true;
                [this.drawingState.lastX, this.drawingState.lastY] = [e.offsetX, e.offsetY];
            }

            draw(e) {
                if (!this.drawingState.isDrawing) return;
                this.drawingContext.beginPath();
                this.drawingContext.moveTo(this.drawingState.lastX, this.drawingState.lastY);
                this.drawingContext.lineTo(e.offsetX, e.offsetY);
                this.drawingContext.strokeStyle = this.drawingState.currentColor;
                this.drawingContext.lineWidth = this.drawingState.currentSize;
                this.drawingContext.lineCap = 'round';
                this.drawingContext.stroke();
                [this.drawingState.lastX, this.drawingState.lastY] = [e.offsetX, e.offsetY];
            }

            stopDrawing() {
                this.drawingState.isDrawing = false;
            }

            saveNotes(isAuto = false) {
                const notesContent = document.getElementById('notesTextarea').value;
                const canvasData = this.drawingCanvas ? this.drawingCanvas.toDataURL() : null;
                const notesData = { text: notesContent, drawing: canvasData, timestamp: new Date().toISOString() };
                localStorage.setItem('aiTutorNotes', JSON.stringify(notesData));
                if (!isAuto) {
                    this.showNotification("Notes saved successfully! ");
                }
            }

            endSession() {
                if (confirm('Are you sure you want to end this learning session?')) {
                    this.stopSessionTimer();
                    this.generateProgressSummary();
                    this.switchToPage('summaryPage');
                }
            }

            startNewSession() {
                this.studentData = { name: '', grade: '', sessionStartTime: null };
                this.sessionDuration = 0;
                localStorage.removeItem('aiTutorStudentData');
                localStorage.removeItem('aiTutorNotes');
                this.switchToPage('welcomePage');
                document.getElementById('studentName').value = '';
                document.getElementById('selectedGrade').value = '';
                document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('selected'));
                this.validateForm();
            }

            shareProgress() {
                const summary = this.generateProgressSummary(true);
                const shareText = `Check out my AI Tutor session summary:\n\n${summary}`;
                if (navigator.share) {
                    navigator.share({
                        title: 'AI Tutor Session Summary',
                        text: shareText,
                    }).then(() => {
                        this.showNotification('Summary shared successfully!');
                    }).catch((error) => {
                        console.error('Error sharing:', error);
                    });
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        this.showNotification('Summary copied to clipboard!');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                    });
                }
            }
            
            generateProgressSummary(forShare = false) {
                const duration = Math.floor(this.sessionDuration / 60);
                let summary = `Student: ${this.studentData.name}\nGrade: ${this.studentData.grade}\nDate: ${new Date().toLocaleDateString()}\nDuration: ${duration} minutes\n`;

                if (forShare) {
                    const notes = localStorage.getItem('aiTutorNotes');
                    if (notes) {
                        const notesData = JSON.parse(notes);
                        summary += `\nYour Notes:\n${notesData.text || ''}\n\n`;
                    }
                }
                return summary;
            }

            viewAllProgress() {
                this.showNotification('This feature is coming soon!');
            }

            handleKeyboardShortcuts(e) {
                if (e.key === ' ' && e.target === document.body && this.currentPage === 'mainInterface') {
                    e.preventDefault();
                    this.toggleVoiceRecognition();
                } else if (e.key === 'Escape') {
                    this.closeNotesPanel();
                }
            }
            
            handleWindowResize() {
                if (this.drawingCanvas && document.getElementById('drawMode').style.display !== 'none') {
                    setTimeout(() => this.resizeCanvas(), 500);
                }
            }

            showNotification(message) {
                const notification = document.getElementById('notification');
                if (!notification) {
                    const newNotification = document.createElement('div');
                    newNotification.id = 'notification';
                    document.body.appendChild(newNotification);
                    notification = newNotification;
                }
                notification.style.cssText = `
                    position: fixed;
                    top: 1rem;
                    right: 1rem;
                    background: var(--color-success-500);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 1rem;
                    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                    z-index: 1000;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    max-width: 300px;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            updateFlashcard(shouldShow, word, definition) {
                const cardContainer = document.getElementById('dynamicWordCard');
                if (shouldShow) {
                    cardContainer.innerHTML = `
                        <div class="word-card" data-word="${word}">
                            <div class="card-front">
                                <div class="card-icon"></div>
                                <h3 class="card-title">${word}</h3>
                            </div>
                            <div class="card-back">
                                <p class="card-description">${definition}</p>
                            </div>
                        </div>
                    `;
                    cardContainer.querySelector('.word-card').addEventListener('click', (e) => {
                        e.currentTarget.classList.toggle('flipped');
                        this.showMascotMessage(`Great choice! Let's learn about ${word}! `);
                    });
                } else {
                    cardContainer.innerHTML = '';
                }
            }

            saveStudentData() {
                localStorage.setItem('aiTutorStudentData', JSON.stringify(this.studentData));
            }

            loadSavedData() {
                const savedData = localStorage.getItem('aiTutorStudentData');
                if (savedData) {
                    this.studentData = { ...this.studentData, ...JSON.parse(savedData) };
                }
                
                const savedNotes = localStorage.getItem('aiTutorNotes');
                if (savedNotes) {
                    try {
                        const notesData = JSON.parse(savedNotes);
                        if (typeof notesData === 'string') {
                            document.getElementById('notesTextarea').value = notesData;
                        } else {
                            document.getElementById('notesTextarea').value = notesData.text || '';
                            if (notesData.drawing && this.drawingCanvas) {
                                const img = new Image();
                                img.onload = () => {
                                    this.drawingContext.drawImage(img, 0, 0);
                                };
                                img.src = notesData.drawing;
                            }
                        }
                    } catch (e) {
                        console.error('Error loading saved notes:', e);
                    }
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new AITutorApp();
        });
    </script>
<script id="dhws-dataInjector" src="/public/dhws-data-injector.js"></script>
</body>
</html>