const Index = () => {
  return (
    <div className="min-h-screen">
      <div 
        dangerouslySetInnerHTML={{ 
          __html: `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor</title>
    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary: linear-gradient(45deg, #4CAF50, #45a049);
            --accent: linear-gradient(45deg, #2196F3, #1976D2);
            --glass: rgba(255,255,255,0.12);
            --glass-border: rgba(255,255,255,0.25);
            --shadow: 0 8px 32px rgba(0,0,0,0.12);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.18);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --radius: 20px;
            --radius-sm: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: white;
            line-height: 1.6;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            transition: var(--transition);
        }

        .main-content.with-sidebar { margin-right: 320px; }

        .content-wrapper {
            text-align: center;
            max-width: 600px;
            width: 100%;
        }

        .mascot {
            font-size: clamp(3.5rem, 8vw, 5rem);
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
            user-select: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(3deg); }
        }

        h1, h2 {
            text-shadow: 0 4px 16px rgba(0,0,0,0.4);
            margin-bottom: 1rem;
            font-weight: 800;
        }

        h1 { font-size: clamp(2.2rem, 6vw, 3rem); }
        h2 { font-size: clamp(1.8rem, 5vw, 2.5rem); }

        .subtitle {
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            margin-bottom: 2.5rem;
            opacity: 0.9;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        }

        .glass-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Form Styles */
        .student-info {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            text-align: left;
        }

        .form-group label {
            font-weight: 600;
            font-size: 1.1rem;
            margin-left: 0.5rem;
            color: rgba(255,255,255,0.95);
        }

        .form-input {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: var(--radius-sm);
            padding: 1rem 1.25rem;
            color: white;
            font-size: 1rem;
            width: 100%;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.15);
        }

        .form-input::placeholder { color: rgba(255,255,255,0.7); }
        .form-input option { background: #764ba2; color: white; }

        /* Button Styles */
        .btn {
            border: none;
            border-radius: var(--radius);
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary);
            padding: 1.25rem 2.5rem;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            backdrop-filter: blur(10px);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .btn:hover::before { left: 100%; }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }

        /* Tutor Interface */
        .tutor-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            width: 100%;
        }

        .status-display {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 1.5rem 2rem;
            min-height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: 500;
            text-align: center;
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 100%;
        }

        /* Voice Controls */
        .voice-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .voice-button {
            background: var(--secondary);
            width: clamp(120px, 25vw, 160px);
            height: clamp(120px, 25vw, 160px);
            border: none;
            border-radius: 50%;
            font-size: clamp(2.5rem, 6vw, 3.5rem);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .voice-button:not(:disabled):hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .voice-button:active { transform: scale(0.95); }
        .voice-button:disabled { opacity: 0.6; cursor: not-allowed; }

        .voice-button.listening {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            animation: pulse-listening 1.5s ease-in-out infinite;
        }

        @keyframes pulse-listening {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(244, 67, 54, 0);
            }
        }

        .voice-hint {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
            max-width: 300px;
        }

        /* Reading Prompt */
        .reading-prompt {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 500px;
        }

        .reading-prompt-text {
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .reading-word {
            font-size: clamp(2.5rem, 7vw, 3.5rem);
            font-weight: 900;
            letter-spacing: 0.1em;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            color: #764ba2;
            padding: clamp(1rem, 3vw, 1.5rem) clamp(1.5rem, 5vw, 2.5rem);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 3px solid rgba(255,255,255,0.8);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        /* Notes Panel */
        .notes-sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(25px);
            border-left: 1px solid rgba(255,255,255,0.2);
            transition: var(--transition);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .notes-sidebar.open { right: 0; }

        .notes-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notes-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-notes {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 6px;
            transition: var(--transition);
        }

        .close-notes:hover { background: rgba(255,255,255,0.1); }

        .notes-tools {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .tool-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 0.5rem;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover, .tool-btn.active {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }

        .color-picker {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .color-option:hover, .color-option.active {
            border-color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .brush-size {
            margin-left: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .brush-size input {
            width: 50px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 0.25rem;
            color: white;
            font-size: 0.8rem;
        }

        .notes-content {
            flex: 1;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .notes-canvas-container {
            background: rgba(255,255,255,0.95);
            border-radius: var(--radius-sm);
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            flex: 1;
            position: relative;
        }

        .notes-textarea {
            width: 100%;
            height: 100%;
            padding: 1rem;
            border: none;
            outline: none;
            background: transparent;
            resize: none;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #333;
        }

        .notes-textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        .notes-canvas {
            cursor: crosshair;
            touch-action: none;
            display: block;
        }

        .notes-toggle {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            z-index: 1001;
        }

        .notes-toggle:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .notes-toggle.active { background: var(--secondary); }

        /* Session Summary */
        .session-summary {
            padding: 2rem;
            margin: 2rem 0;
            text-align: left;
        }

        .summary-item {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: var(--glass);
            border-radius: var(--radius-sm);
            border-left: 4px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(20px);
        }

        .summary-item strong {
            color: rgba(255,255,255,0.95);
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Live Captions */
        .live-captions {
            position: fixed;
            bottom: clamp(2rem, 8vh, 6rem);
            left: 50%;
            transform: translateX(-50%);
            min-width: 200px;
            max-width: 85vw;
            background: rgba(0,0,0,0.9);
            color: white;
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            z-index: 1000;
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow);
            transition: var(--transition);
            pointer-events: none;
        }

        .live-captions.user-caption {
            background: rgba(76, 175, 80, 0.95);
            border: 2px solid #4CAF50;
        }

        .live-captions.bot-caption {
            background: rgba(33, 150, 243, 0.95);
            border: 2px solid #2196F3;
        }

        /* Utility Classes */
        .hidden { display: none !important; }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .main-content.with-sidebar { margin-right: 0; }
            .notes-sidebar { width: 100vw; right: -100vw; }
            .notes-toggle {
                top: 1rem;
                right: 1rem;
                width: 48px;
                height: 48px;
                font-size: 1.3rem;
            }
            .voice-button {
                width: clamp(100px, 30vw, 140px);
                height: clamp(100px, 30vw, 140px);
            }
            .content-wrapper { padding: 0 1rem; }
            .form-input { font-size: 16px; }
        }

        @media (max-width: 480px) {
            .main-content { padding: 1rem; }
            .glass-panel { padding: 1.5rem; }
            .notes-tools { padding: 0.75rem; }
            .tool-btn { width: 32px; height: 32px; font-size: 0.9rem; }
            .live-captions {
                bottom: 1rem;
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
            }
        }

        /* Focus States */
        .voice-button:focus,
        .btn:focus,
        .notes-toggle:focus,
        .tool-btn:focus {
            outline: 2px solid rgba(255,255,255,0.6);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content" id="main-content">
            <div class="content-wrapper">
                <!-- Welcome Screen -->
                <div id="welcome-screen">
                    <div class="mascot">🎓</div>
                    <h1>Hi! I'm your AI Tutor!</h1>
                    <p class="subtitle">Ready to learn and explore together?</p>
                    
                    <div class="student-info glass-panel">
                        <div class="form-group">
                            <label for="student-name">Student Name</label>
                            <input type="text" id="student-name" class="form-input" placeholder="What's your name?" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="student-grade">Grade Level</label>
                            <select id="student-grade" class="form-input">
                                <option value="">Select your grade</option>
                                <option value="PreK">Pre-K</option>
                                <option value="K">Kindergarten</option>
                                <option value="1">1st Grade</option>
                                <option value="2">2nd Grade</option>
                                <option value="3">3rd Grade</option>
                                <option value="4">4th Grade</option>
                                <option value="5">5th Grade</option>
                                <option value="6">6th Grade</option>
                                <option value="7">7th Grade</option>
                                <option value="8">8th Grade</option>
                                <option value="9">9th Grade</option>
                                <option value="10">10th Grade</option>
                                <option value="11">11th Grade</option>
                                <option value="12">12th Grade</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="startTutoring()">Start Learning!</button>
                    </div>
                </div>

                <!-- Tutor Interface -->
                <div id="tutor-interface" class="hidden">
                    <div class="tutor-main">
                        <div class="mascot">🤖</div>
                        <h2>Let's Learn Together!</h2>
                        
                        <div id="reading-prompt-container"></div>
                        
                        <div class="status-display" id="status">Press the microphone to start talking!</div>
                        
                        <div class="voice-section">
                            <div class="mic-container">
                                <button class="voice-button" id="mic-btn" onclick="toggleListening()" aria-label="Toggle microphone">🎤</button>
                            </div>
                            <p class="voice-hint">Tap the microphone and start speaking</p>
                            <button class="btn btn-secondary" onclick="endSession()">End Session</button>
                        </div>
                    </div>
                </div>

                <!-- Session Summary -->
                <div id="session-summary" class="session-summary glass-panel hidden">
                    <h2>Session Complete! 🎉</h2>
                    <div id="summary-content"></div>
                    <button class="btn btn-primary" onclick="startNewSession()">Start New Session</button>
                </div>
            </div>
        </div>

        <!-- Notes Toggle -->
        <button class="notes-toggle" id="notes-toggle" onclick="toggleNotes()" title="Toggle Notes" aria-label="Toggle notes panel">📝</button>

        <!-- Notes Sidebar -->
        <div class="notes-sidebar" id="notes-sidebar">
            <div class="notes-header">
                <div class="notes-title">📝 Learning Notes</div>
                <button class="close-notes" onclick="toggleNotes()" aria-label="Close notes">×</button>
            </div>
            
            <div class="notes-tools">
                <button class="tool-btn" id="text-tool" onclick="switchToText()" title="Text Mode" aria-label="Switch to text mode">📖</button>
                <button class="tool-btn active" id="draw-tool" onclick="switchToDraw()" title="Draw Mode" aria-label="Switch to draw mode">🖌️</button>
                <button class="tool-btn" onclick="clearNotes()" title="Clear All" aria-label="Clear all notes">🗑️</button>
                
                <div class="color-picker">
                    <div class="color-option active" style="background: #000" onclick="setColor('#000')" data-color="#000" title="Black"></div>
                    <div class="color-option" style="background: #e74c3c" onclick="setColor('#e74c3c')" data-color="#e74c3c" title="Red"></div>
                    <div class="color-option" style="background: #3498db" onclick="setColor('#3498db')" data-color="#3498db" title="Blue"></div>
                    <div class="color-option" style="background: #2ecc71" onclick="setColor('#2ecc71')" data-color="#2ecc71" title="Green"></div>
                    <div class="color-option" style="background: #f39c12" onclick="setColor('#f39c12')" data-color="#f39c12" title="Orange"></div>
                </div>
                
                <div class="brush-size">
                    <span style="font-size: 0.8rem; opacity: 0.8;">Size:</span>
                    <input type="range" id="brush-size" min="1" max="8" value="3" onchange="setBrushSize(this.value)" aria-label="Brush size">
                </div>
            </div>
            
            <div class="notes-content">
                <div class="notes-canvas-container">
                    <textarea class="notes-textarea" id="notes-text" placeholder="Type your learning notes here..." style="display: none;"></textarea>
                    <canvas class="notes-canvas" id="notes-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Live Captions -->
        <div id="live-captions" class="live-captions hidden" aria-live="polite"></div>
    </div>

    <script>
        // Consolidated State Management
        const state = {
            isListening: false,
            recognition: null,
            speechSynthesis: window.speechSynthesis,
            currentSessionId: null,
            isProcessing: false,
            sessionStarted: false,
            selectedVoice: null,
            conversationContext: [],
            chatHistory: [],
            currentSubject: null,
            flashCardsEnabled: true,
            notesOpen: false
        };

        const notesState = {
            isDrawing: false,
            isTextMode: false,
            currentColor: '#000',
            brushSize: 3,
            canvas: null,
            ctx: null
        };
        
        const API_BASE_URL = 'https://ai-tutor-ww9f.onrender.com/api';
        
        // Utility Functions
        const $ = id => document.getElementById(id);
        const updateStatus = msg => $('status').textContent = msg;
        const addToConversation = (sender, message) => state.chatHistory.push({ sender, message });

        // Enhanced Speech Setup
        async function initializeSpeechSynthesis() {
            return new Promise(resolve => {
                const selectVoice = () => {
                    const voices = state.speechSynthesis.getVoices();
                    const preferred = ['Samantha', 'Karen', 'Susan', 'Victoria', 'Google UK English Female'];
                    state.selectedVoice = preferred.map(name => 
                        voices.find(voice => voice.name.includes(name))
                    ).find(Boolean) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                    resolve();
                };

                if (state.speechSynthesis.getVoices().length > 0) selectVoice();
                else {
                    state.speechSynthesis.onvoiceschanged = selectVoice;
                    setTimeout(selectVoice, 1000);
                }
            });
        }

        function speakWithPromise(text) {
            return new Promise(resolve => {
                if (state.speechSynthesis.speaking) state.speechSynthesis.cancel();
                const micBtn = $('mic-btn');

                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    Object.assign(utterance, {
                        voice: state.selectedVoice,
                        rate: 0.8,
                        pitch: 1.0,
                        volume: 1.0
                    });

                    utterance.onstart = () => {
                        micBtn.disabled = true;
                        showLiveCaption(text, 'bot');
                    };

                    const cleanup = () => {
                        $('live-captions').classList.add('hidden');
                        micBtn.disabled = false;
                        resolve();
                    };

                    utterance.onend = utterance.onerror = cleanup;
                    state.speechSynthesis.speak(utterance);
                }, 100);
            });
        }

        // Enhanced Speech Recognition
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                updateStatus("Speech recognition not supported. Try Chrome or Edge!");
                return false;
            }

            try {
                state.recognition = new SpeechRecognition();
                Object.assign(state.recognition, {
                    continuous: false,
                    interimResults: true,
                    lang: 'en-US',
                    maxAlternatives: 1
                });

                // Event Handlers
                state.recognition.onstart = () => {
                    state.isListening = true;
                    updateMicButton();
                    updateStatus("I'm listening! Go ahead and speak.");
                };

                state.recognition.onend = () => {
                    state.isListening = false;
                    updateMicButton();
                    if (!state.isProcessing) updateStatus("Press the microphone to continue!");
                };

                state.recognition.onresult = event => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    
                    showLiveCaption(transcript, 'user');

                    if (event.results[event.results.length - 1].isFinal) {
                        if (transcript.trim() && !state.isProcessing) {
                            handleUserInput(transcript.trim());
                        } else if (!state.isProcessing) {
                            updateStatus("I didn't catch that clearly. Please try again!");
                        }
                        setTimeout(() => $('live-captions').classList.add('hidden'), 600);
                    }
                };

                state.recognition.onerror = event => {
                    state.isListening = false;
                    state.isProcessing = false;
                    updateMicButton();
                    
                    const errorMessages = {
                        'no-speech': "I didn't hear anything. Please try speaking closer.",
                        'audio-capture': "Couldn't access microphone. Check permissions.",
                        'not-allowed': "Microphone access denied. Enable in browser settings.",
                        'network': "Network error. Check internet connection."
                    };
                    
                    updateStatus(errorMessages[event.error] || `Speech error: ${event.error}. Please try again!`);
                };

                return true;
            } catch (error) {
                console.error('Failed to initialize speech recognition:', error);
                updateStatus("Failed to initialize microphone. Please refresh and try again.");
                return false;
            }
        }

        // Reading Word Display
        function showReadingWordPrompt(prompt, word) {
            const container = $('reading-prompt-container');
            container.innerHTML = `
                <div class="reading-prompt">
                    <div class="reading-prompt-text">${prompt}</div>
                    <div class="reading-word">${word}</div>
                </div>
            `;
        }

        function clearReadingPrompt() {
            $('reading-prompt-container').innerHTML = '';
        }

        // Session Management
        async function startTutoring() {
            await initializeSpeechSynthesis();
            
            if (!initializeSpeechRecognition()) {
                alert('Speech recognition not supported. Use Chrome or Edge for best experience.');
                return;
            }

            const studentName = $('student-name').value.trim();
            const studentGrade = $('student-grade').value;

            try {
                updateStatus("Starting your session...");

                const response = await fetch(`${API_BASE_URL}/session/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentName: studentName || 'Student',
                        grade: studentGrade || 'K',
                        subjects: []
                    })
                });

                if (!response.ok) throw new Error('Failed to start session');

                const data = await response.json();
                state.currentSessionId = data.sessionId;
                state.sessionStarted = true;
                
                $('welcome-screen').classList.add('hidden');
                $('tutor-interface').classList.remove('hidden');
                
                const welcomeMessage = data.welcomeMessage || 
                    `Hi ${studentName || 'there'}! I'm your AI tutor and I'm excited to learn with you today. What would you like to explore?`;

                await speakWithPromise(welcomeMessage);
                addToConversation('tutor', welcomeMessage);
                updateStatus("Press the microphone to start talking!");

            } catch (error) {
                console.error('Error starting session:', error);
                alert("Failed to start session. Please try again later.");
            }
        }

        async function handleUserInput(input) {
            if (state.isProcessing || !state.sessionStarted) return;

            const cmd = input.trim().toLowerCase();
            if (cmd === 'stop showing flash cards') {
                state.flashCardsEnabled = false;
                clearReadingPrompt();
                updateStatus("Flash cards disabled.");
            }

            state.isProcessing = true;
            updateStatus("Processing your request...");

            addToConversation('user', input);
            state.conversationContext.push({ role: 'user', content: input });

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: state.currentSessionId,
                        userMessage: input
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                const tutorResponse = data.response;

                if (!tutorResponse.trim()) throw new Error('Empty response from API');

                const shouldCard = state.flashCardsEnabled && 
                                 data.readingWord && 
                                 (data.subject === 'reading' || data.subject === 'math');

                if (shouldCard) {
                    showReadingWordPrompt(tutorResponse, data.readingWord);
                } else {
                    clearReadingPrompt();
                }

                await speakWithPromise(tutorResponse);
                addToConversation('tutor', tutorResponse);
                state.conversationContext.push({ role: 'assistant', content: tutorResponse });
                if (data.subject) state.currentSubject = data.subject;

            } catch (error) {
                console.error('Error getting response:', error);

                if (error.name === 'AbortError') {
                    updateStatus("Request timed out. Please try again.");
                    await speakWithPromise("Sorry, that took too long. Please try asking again.");
                } else {
                    const fallback = generateFallbackResponse(input);
                    addToConversation('tutor', fallback);
                    await speakWithPromise(fallback);
                }
            } finally {
                state.isProcessing = false;
                updateStatus("Press the microphone to continue our conversation!");
            }
        }

        function generateFallbackResponse(input) {
            const inputLower = input.toLowerCase();
            const responses = {
                math: "Math is exciting! What type of math problem would you like to work on?",
                read: "Reading opens up amazing worlds! What kind of books do you enjoy?",
                science: "Science is all around us! What scientific topic are you curious about?",
                history: "History tells incredible stories! What time period interests you?"
            };
            
            const matchedSubject = Object.keys(responses).find(subject => inputLower.includes(subject));
            
            if (matchedSubject) return responses[matchedSubject];
            
            const generalResponses = [
                "That's a great question! I'm having trouble connecting right now, but I'd love to explore that topic with you. Can you tell me more?",
                "I'm excited to learn about that with you! While I sort out a technical issue, could you share what interests you most about this?",
                "Your curiosity is wonderful! I'm experiencing some connection issues, but let's keep the conversation going. What would you like to discover?"
            ];
            
            return generalResponses[Math.floor(Math.random() * generalResponses.length)];
        }

        // Notes Management
        function toggleNotes() {
            state.notesOpen = !state.notesOpen;
            const sidebar = $('notes-sidebar');
            const mainContent = $('main-content');
            const toggle = $('notes-toggle');
            
            if (state.notesOpen) {
                sidebar.classList.add('open');
                if (window.innerWidth > 768) {
                    mainContent.classList.add('with-sidebar');
                }
                toggle.classList.add('active');
                setTimeout(() => initializeCanvas(), 100);
            } else {
                sidebar.classList.remove('open');
                mainContent.classList.remove('with-sidebar');
                toggle.classList.remove('active');
            }
        }

        function initializeCanvas() {
            const canvas = $('notes-canvas');
            if (!canvas) return;
            
            const container = canvas.parentElement;
            canvas.width = container.clientWidth - 32;
            canvas.height = container.clientHeight - 32;

            notesState.canvas = canvas;
            notesState.ctx = canvas.getContext('2d');
            
            // Event Listeners
            const events = {
                mouse: [
                    ['mousedown', startDrawing],
                    ['mousemove', draw],
                    ['mouseup', stopDrawing],
                    ['mouseout', stopDrawing]
                ],
                touch: [
                    ['touchstart', handleTouch],
                    ['touchmove', handleTouch],
                    ['touchend', stopDrawing]
                ]
            };

            [...events.mouse, ...events.touch].forEach(([event, handler]) => {
                canvas.addEventListener(event, handler);
            });
        }

        function startDrawing(e) {
            if (notesState.isTextMode) return;
            notesState.isDrawing = true;
            const rect = notesState.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            notesState.ctx.beginPath();
            notesState.ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!notesState.isDrawing || notesState.isTextMode) return;
            
            const rect = notesState.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            Object.assign(notesState.ctx, {
                lineWidth: notesState.brushSize,
                lineCap: 'round',
                strokeStyle: notesState.currentColor
            });
            
            notesState.ctx.lineTo(x, y);
            notesState.ctx.stroke();
            notesState.ctx.beginPath();
            notesState.ctx.moveTo(x, y);
        }

        function stopDrawing() {
            notesState.isDrawing = false;
            notesState.ctx.beginPath();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            notesState.canvas.dispatchEvent(mouseEvent);
        }

        function switchToText() {
            notesState.isTextMode = true;
            $('text-tool').classList.add('active');
            $('draw-tool').classList.remove('active');
            $('notes-text').style.display = 'block';
            $('notes-canvas').style.display = 'none';
        }

        function switchToDraw() {
            notesState.isTextMode = false;
            $('draw-tool').classList.add('active');
            $('text-tool').classList.remove('active');
            $('notes-text').style.display = 'none';
            $('notes-canvas').style.display = 'block';
            if (!notesState.canvas) setTimeout(initializeCanvas, 100);
        }

        function setColor(color) {
            notesState.currentColor = color;
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function setBrushSize(size) {
            notesState.brushSize = parseInt(size);
        }

        function clearNotes() {
            if (notesState.isTextMode) {
                $('notes-text').value = '';
            } else {
                if (notesState.ctx) {
                    notesState.ctx.clearRect(0, 0, notesState.canvas.width, notesState.canvas.height);
                }
            }
        }

        // Voice Controls
        function toggleListening() {
            if (!state.recognition) {
                updateStatus("Speech recognition not available!");
                return;
            }
            if (state.isProcessing) {
                updateStatus("Please wait, processing your message...");
                return;
            }

            if (state.isListening) {
                try {
                    state.recognition.stop();
                } catch (e) {
                    console.error('Error stopping recognition:', e);
                }
            } else {
                try {
                    state.recognition.start();
                } catch (e) {
                    console.error('Error starting microphone:', e);
                    updateStatus("Error starting microphone. Please check permissions and try again.");
                }
            }
        }

        function updateMicButton() {
            const micBtn = $('mic-btn');
            micBtn.classList.toggle('listening', state.isListening);
            micBtn.innerHTML = state.isListening ? '🔴' : '🎤';
        }

        let lastCaptionTime = 0;
        function showLiveCaption(text, type = 'bot') {
            const now = Date.now();
            if (now - lastCaptionTime < 200) return; 
            lastCaptionTime = now;
            const captionsDiv = $('live-captions');
            captionsDiv.textContent = text;
            captionsDiv.className = `live-captions ${type}-caption`;
            captionsDiv.classList.remove('hidden');
        }

        // Session End
        async function endSession() {
            state.speechSynthesis.cancel();
            if (state.isListening) state.recognition.stop();
            
            try {
                const response = await fetch(`${API_BASE_URL}/session/${state.currentSessionId}/summary`);
                await fetch(`${API_BASE_URL}/session/${state.currentSessionId}/end`, { method: 'POST' });

                const summary = response.ok ? await response.json() : null;
                showSessionSummary(summary);
            } catch (error) {
                console.error('Error getting summary:', error);
                showSessionSummary(null);
            }
        }

        async function showSessionSummary(summary) {
            $('tutor-interface').classList.add('hidden');
            $('session-summary').classList.remove('hidden');
            
            const summaryContent = $('summary-content');
            
            if (summary) {
                const allSuggestions = [
                    ...(Array.isArray(summary.suggestions) ? summary.suggestions : [summary.suggestions]),
                    ...(Array.isArray(summary.nextSteps) ? summary.nextSteps : [summary.nextSteps])
                ].filter(Boolean);

                summaryContent.innerHTML = `
                    <div class="summary-item"><strong>Duration:</strong> ${summary.duration}</div>
                    <div class="summary-item"><strong>Off-topic Requests:</strong> ${summary.totalWarnings}</div>
                    <div class="summary-item"><strong>Topics Explored:</strong> ${summary.topicsExplored}</div>
                    <div class="summary-item"><strong>Learning Highlights:</strong><br>${summary.highlights.join('<br>')}</div>
                    <div class="summary-item"><strong>Next Steps:</strong><br>${allSuggestions.length ? allSuggestions.join('<br>') : 'Keep asking great questions!'}</div>
                `;
            } else {
                summaryContent.innerHTML = `
                    <div class="summary-item"><strong>Session Complete!</strong> You had a wonderful learning session today!</div>
                    <div class="summary-item"><strong>Keep Learning:</strong> Continue exploring topics that spark your curiosity!</div>
                `;
            }
            
            await speakWithPromise("You had a wonderful learning session today! Keep being curious and asking great questions.");
        }

        function startNewSession() {
            state.speechSynthesis.cancel();
            Object.assign(state, {
                currentSessionId: null,
                isProcessing: false,
                sessionStarted: false,
                isListening: false,
                conversationContext: [],
                chatHistory: [],
                currentSubject: null,
                flashCardsEnabled: true,
                notesOpen: false
            });
            
            $('session-summary').classList.add('hidden');
            $('welcome-screen').classList.remove('hidden');
            $('student-name').value = '';
            $('student-grade').value = '';
            
            // Close notes panel
            $('notes-sidebar').classList.remove('open');
            $('main-content').classList.remove('with-sidebar');
            $('notes-toggle').classList.remove('active');
            
            clearReadingPrompt();
            updateMicButton();
            updateStatus("Ready to start a new session!");
        }

        // Event Listeners
        const eventHandlers = [
            ['blur', () => { if (state.isListening) state.recognition.stop(); }],
            ['focus', () => { if (state.sessionStarted) updateStatus("Press the microphone to continue our conversation!"); }],
            ['resize', () => {
                if (notesState.canvas && state.notesOpen) setTimeout(initializeCanvas, 100);
                
                if (window.innerWidth <= 768 && state.notesOpen) {
                    $('main-content').classList.remove('with-sidebar');
                } else if (window.innerWidth > 768 && state.notesOpen) {
                    $('main-content').classList.add('with-sidebar');
                }
            }]
        ];

        eventHandlers.forEach(([event, handler]) => {
            window.addEventListener(event, handler);
        });

        // Initialize App
        window.onload = async function() {
            console.log('🚀 AI Tutor loading...');
            await initializeSpeechSynthesis();
            console.log('✅ App loaded successfully');
        };
    </script>
</body>
</html>