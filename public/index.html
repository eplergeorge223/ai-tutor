<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255,255,255,0.1);
            --glass-border: rgba(255,255,255,0.2);
            --accent-green: linear-gradient(45deg, #4CAF50, #45a049);
            --accent-blue: linear-gradient(45deg, #2196F3, #1976D2);
            --accent-red: linear-gradient(45deg, #f44336, #d32f2f);
            --accent-yellow: linear-gradient(45deg, #ffcc00, #ffa500);
            --shadow-soft: 0 8px 32px rgba(0,0,0,0.12);
            --shadow-strong: 0 12px 40px rgba(0,0,0,0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --radius: 20px;
            --radius-sm: 15px;
            --radius-lg: 25px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 2rem;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(240,147,251,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container { text-align: center; max-width: 800px; width: 100%; }

        .mascot {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }

        h1, h2 {
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        h1 { font-size: 2.8rem; }
        h2 { font-size: 2rem; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
            padding: 2rem;
        }

        .glass-panel:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-strong); 
        }

        .student-info {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            font-size: 1.1rem;
            margin-left: 0.5rem;
        }

        .form-group input, .form-group select {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 1rem 1.5rem;
            color: white;
            font-size: 1rem;
            width: 100%;
            max-width: 320px;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
        }

        .form-group input::placeholder { color: rgba(255,255,255,0.7); }
        .form-group select option { background: #764ba2; color: white; }

        .btn {
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before { left: 100%; }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-strong); }

        .btn-primary {
            background: var(--accent-green);
            padding: 1.5rem 3rem;
            font-size: 1.4rem;
            color: white;
            box-shadow: var(--shadow-soft);
            margin: 1rem 0;
        }

        .btn-secondary {
            background: var(--accent-red);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            color: white;
            margin: 0.5rem;
        }

        .voice-button {
            background: var(--accent-blue);
            width: 120px; height: 120px;
            border-radius: 50%;
            font-size: 2rem;
            color: white;
            margin: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }

        .voice-button:hover { transform: scale(1.05); }
        .voice-button:active { transform: scale(0.95); }

        .voice-button.listening {
            background: var(--accent-red);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
        }

        .status {
            font-size: 1.2rem;
            margin: 2rem 0;
            min-height: 4rem;
            padding: 1.5rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .notes-section {
            margin: 2rem 0;
            max-width: 100%;
        }

        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .notes-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notes-tools {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.75rem;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
            width: 45px; height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover, .tool-btn.active {
            background: var(--glass-border);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-1px);
        }

        .notes-canvas-container {
            background: rgba(255,255,255,0.95);
            border-radius: var(--radius-sm);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            position: relative;
            min-height: 300px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: none;
            outline: none;
            background: transparent;
            resize: vertical;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            color: #333;
        }

        .notes-textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        .notes-canvas {
            position: absolute;
            top: 0; left: 0;
            cursor: crosshair;
            touch-action: none;
        }

        .drawing-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .color-picker {
            display: flex;
            gap: 0.3rem;
        }

        .color-option {
            width: 24px; height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .color-option:hover, .color-option.active {
            border-color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .brush-size {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brush-size input {
            width: 80px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 5px;
            outline: none;
        }

        .live-captions {
            position: fixed;
            bottom: 8vh;
            left: 50%;
            transform: translateX(-50%);
            min-width: 220px;
            max-width: 90vw;
            background: rgba(0,0,0,0.85);
            color: white;
            font-size: 1.3rem;
            font-weight: 500;
            padding: 1.2rem 2.5rem;
            border-radius: var(--radius);
            text-align: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-strong);
            transition: var(--transition);
            pointer-events: none;
        }

        .live-captions.user-caption {
            background: rgba(76, 175, 80, 0.9);
            border: 2px solid #4CAF50;
        }

        .live-captions.bot-caption {
            background: rgba(33, 150, 243, 0.9);
            border: 2px solid #2196F3;
        }

        .reading-prompt {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .reading-word {
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 0.1em;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            color: #764ba2;
            padding: 1.5rem 3rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border: 3px solid rgba(255,255,255,0.8);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .session-summary {
            text-align: left;
        }

        .summary-item {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            border-left: 4px solid rgba(255,255,255,0.5);
        }

        .summary-item strong { color: rgba(255,255,255,0.9); }

        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            color: #333;
            border-radius: var(--radius);
            padding: 2rem;
            width: 95vw;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 1rem; right: 1.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-btn:hover { color: #f44336; transform: scale(1.1); }

        .chat-message {
            margin: 0.75rem 0;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .user-message {
            background: rgba(76, 175, 80, 0.15);
            margin-left: 1rem;
            border-left: 3px solid #4CAF50;
        }

        .tutor-message {
            background: rgba(33, 150, 243, 0.15);
            margin-right: 1rem;
            border-left: 3px solid #2196F3;
        }

        .error-status {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .processing-status {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .hidden { display: none !important; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .voice-controls { flex-direction: row; justify-content: center; }
            .container { padding: 0.5rem; }
            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.8rem; }
            .voice-button { width: 100px; height: 100px; font-size: 1.5rem; }
            .btn-primary { padding: 1rem 2rem; font-size: 1.2rem; }
            .student-info { padding: 1.5rem; }
            .reading-word { font-size: 2.8rem; padding: 1rem 2rem; }
            .notes-header { flex-direction: column; align-items: stretch; }
            .notes-tools { justify-content: center; }
        }

        @media (max-width: 480px) {
            body { padding: 1rem; }
            .mascot { font-size: 3rem; }
            .status { font-size: 1rem; padding: 1rem; }
            .live-captions { font-size: 1.1rem; padding: 1rem 2rem; }
            .brush-size input { width: 60px; }
            .drawing-controls { gap: 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcome-screen">
            <div class="mascot">üéì</div>
            <h1>Hi! I'm your AI Tutor!</h1>
            <p style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9;">Ready to learn and explore together?</p>
            
            <div class="student-info glass-panel">
                <div class="form-group">
                    <label for="student-name">Student</label>
                    <input type="text" id="student-name" placeholder="What's your name?" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="student-grade">Grade</label>
                    <select id="student-grade">
                        <option value="">Select your grade</option>
                        <option value="PreK">Pre-K</option>
                        <option value="K">Kindergarten</option>
                        <option value="1">1st Grade</option>
                        <option value="2">2nd Grade</option>
                        <option value="3">3rd Grade</option>
                        <option value="4">4th Grade</option>
                        <option value="5">5th Grade</option>
                        <option value="6">6th Grade</option>
                        <option value="7">7th Grade</option>
                        <option value="8">8th Grade</option>
                        <option value="9">9th Grade</option>
                        <option value="10">10th Grade</option>
                        <option value="11">11th Grade</option>
                        <option value="12">12th Grade</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startTutoring()">Start Learning!</button>
        </div>

        <!-- Tutor Interface -->
        <div id="tutor-interface" class="hidden">
            <div class="mascot">ü§ñ</div>
            <h2>Let's Learn Together!</h2>
            
            <div class="status glass-panel" id="status">Press the microphone to start talking!</div>
            
            <div class="voice-controls">
                <button class="voice-button btn" id="mic-btn" onclick="toggleListening()">üé§</button>
                <button class="btn btn-secondary" onclick="endSession()">End Session</button>
            </div>

            <div class="notes-section glass-panel">
                <div class="notes-header">
                    <div class="notes-title">üìù My Learning Notes</div>
                    <div class="notes-tools">
                        <button class="tool-btn" id="text-tool" onclick="switchToText()" title="Text Mode">üìñ</button>
                        <button class="tool-btn active" id="draw-tool" onclick="switchToDraw()" title="Draw Mode">üñåÔ∏è</button>
                        <button class="tool-btn" onclick="clearNotes()" title="Clear All">üóëÔ∏è</button>
                        
                        <div class="drawing-controls">
                            <div class="color-picker">
                                <div class="color-option active" style="background: #000" onclick="setColor('#000')" data-color="#000"></div>
                                <div class="color-option" style="background: #e74c3c" onclick="setColor('#e74c3c')" data-color="#e74c3c"></div>
                                <div class="color-option" style="background: #3498db" onclick="setColor('#3498db')" data-color="#3498db"></div>
                                <div class="color-option" style="background: #2ecc71" onclick="setColor('#2ecc71')" data-color="#2ecc71"></div>
                                <div class="color-option" style="background: #f39c12" onclick="setColor('#f39c12')" data-color="#f39c12"></div>
                                <div class="color-option" style="background: #9b59b6" onclick="setColor('#9b59b6')" data-color="#9b59b6"></div>
                            </div>
                            <div class="brush-size">
                                <input type="range" id="brush-size" min="1" max="10" value="3" onchange="setBrushSize(this.value)">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="notes-canvas-container">
                    <textarea class="notes-textarea" id="notes-text" placeholder="Type your learning notes here..." style="display: none;"></textarea>
                    <canvas class="notes-canvas" id="notes-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Session Summary -->
        <div id="session-summary" class="session-summary glass-panel hidden">
            <h2>Session Complete! üéâ</h2>
            <div id="summary-content"></div>
            <button class="btn btn-primary" onclick="startNewSession()">Start New Session</button>
        </div>

        <!-- Live Captions -->
        <div id="live-captions" class="live-captions hidden" aria-live="polite"></div>

        <!-- Chat History Modal -->
        <div id="chat-history-modal" class="modal hidden">
            <div class="modal-content">
                <button onclick="closeHistory()" class="close-btn">&times;</button>
                <h3>Chat History</h3>
                <div id="full-chat-history"></div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced AI Tutor Application
        const app = {
            // Core state
            state: {
                isListening: false,
                recognition: null,
                speechSynthesis: window.speechSynthesis,
                currentSessionId: null,
                isProcessing: false,
                sessionStarted: false,
                selectedVoice: null,
                conversationContext: [],
                chatHistory: [],
                currentSubject: null,
                lastCaptionTime: 0,
                connectionRetries: 0,
                maxRetries: 3
            },

            // Configuration
            config: {
                API_BASE_URL: 'https://ai-tutor-ww9f.onrender.com/api',
                SPEECH_SETTINGS: {
                    rate: 0.8,
                    pitch: 1.0,
                    volume: 1.0
                },
                RECOGNITION_SETTINGS: {
                    continuous: false,
                    interimResults: true,
                    lang: 'en-US',
                    maxAlternatives: 1
                }
            },

            // Utility functions
            utils: {
                $: id => document.getElementById(id),
                
                updateStatus: (msg, type = 'normal') => {
                    const status = app.utils.$('status');
                    status.textContent = msg;
                    status.className = `status glass-panel ${type === 'error' ? 'error-status' : type === 'processing' ? 'processing-status' : ''}`;
                },

                addToConversation: (sender, message) => app.state.chatHistory.push({ sender, message }),

                toggleClass: (element, className, condition) => element.classList.toggle(className, condition),

                debounce: (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },

                showError: (message) => {
                    app.utils.updateStatus(message, 'error');
                    console.error(message);
                }
            },

            // Speech synthesis management
            speech: {
                async init() {
                    return new Promise(resolve => {
                        const selectVoice = () => {
                            const voices = app.state.speechSynthesis.getVoices();
                            const preferred = ['Samantha', 'Karen', 'Susan', 'Victoria', 'Google UK English Female', 'Microsoft Zira'];
                            
                            app.state.selectedVoice = preferred.map(name => 
                                voices.find(voice => voice.name.includes(name))
                            ).find(Boolean) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                            
                            resolve();
                        };

                        if (app.state.speechSynthesis.getVoices().length > 0) {
                            selectVoice();
                        } else {
                            app.state.speechSynthesis.onvoiceschanged = selectVoice;
                            setTimeout(selectVoice, 1000);
                        }
                    });
                },

                speak(text) {
                    return new Promise(resolve => {
                        if (app.state.speechSynthesis.speaking) {
                            app.state.speechSynthesis.cancel();
                        }

                        setTimeout(() => {
                            const utterance = new SpeechSynthesisUtterance(text);
                            Object.assign(utterance, {
                                ...app.config.SPEECH_SETTINGS,
                                voice: app.state.selectedVoice,
                                onstart: () => app.ui.showLiveCaption(text, 'bot'),
                                onend: () => { 
                                    app.utils.$('live-captions').classList.add('hidden'); 
                                    resolve(); 
                                },
                                onerror: () => resolve()
                            });

                            try {
                                app.state.speechSynthesis.speak(utterance);
                            } catch (error) {
                                console.error('Speech error:', error);
                                resolve();
                            }
                        }, 100);
                    });
                }
            },

            // Speech recognition management
            recognition: {
                init() {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (!SpeechRecognition) {
                        app.utils.showError("Speech recognition not supported. Please use Chrome, Edge, or Safari!");
                        return false;
                    }

                    app.state.recognition = new SpeechRecognition();
                    Object.assign(app.state.recognition, app.config.RECOGNITION_SETTINGS);

                    app.state.recognition.onstart = () => {
                        app.state.isListening = true;
                        app.ui.updateMicButton();
                        app.utils.updateStatus("I'm listening! Go ahead and speak.");
                    };

                    app.state.recognition.onend = () => {
                        app.state.isListening = false;
                        app.ui.updateMicButton();
                        if (!app.state.isProcessing) {
                            app.utils.updateStatus("Press the microphone to continue!");
                        }
                    };

                    app.state.recognition.onresult = event => {
                        const transcript = Array.from(event.results)
                            .map(result => result[0].transcript)
                            .join('');
                        
                        app.ui.showLiveCaption(transcript, 'user');

                        if (event.results[event.results.length - 1].isFinal) {
                            const cleanTranscript = transcript.trim();
                            if (cleanTranscript && !app.state.isProcessing) {
                                app.handleUserInput(cleanTranscript);
                            } else if (!app.state.isProcessing) {
                                app.utils.updateStatus("I didn't catch that clearly. Please try again!");
                            }
                            
                            setTimeout(() => app.utils.$('live-captions').classList.add('hidden'), 800);
                        }
                    };

                    app.state.recognition.onerror = event => {
                        app.state.isListening = false;
                        app.state.isProcessing = false;
                        app.ui.updateMicButton();
                        
                        const errorMessages = {
                            'no-speech': "I didn't hear anything. Please try speaking closer to the microphone.",
                            'audio-capture': "Couldn't access microphone. Please check your device permissions.",
                            'not-allowed': "Microphone access denied. Please enable microphone in your browser settings.",
                            'network': "Network error. Please check your internet connection.",
                            'service-not-allowed': "Speech service not available. Please try again later.",
                            'bad-grammar': "Please try speaking more clearly.",
                            'language-not-supported': "Language not supported. Please use English."
                        };
                        
                        const message = errorMessages[event.error] || `Recognition error: ${event.error}. Please try again!`;
                        app.utils.showError(message);
                    };

                    return true;
                },

                start() {
                    if (!app.state.recognition) {
                        app.utils.showError("Speech recognition not available!");
                        return;
                    }
                    
                    if (app.state.isProcessing) {
                        app.utils.updateStatus("Please wait, I'm still processing your message...", 'processing');
                        return;
                    }
                    
                    try {
                        app.state.recognition.start();
                    } catch (error) {
                        console.error('Recognition start error:', error);
                        app.utils.showError("Error starting microphone. Please try again.");
                    }
                },

                stop() {
                    if (app.state.recognition && app.state.isListening) {
                        app.state.recognition.stop();
                    }
                }
            },

            // UI management
            ui: {
                updateMicButton() {
                    const micBtn = app.utils.$('mic-btn');
                    micBtn.classList.toggle('listening', app.state.isListening);
                    micBtn.innerHTML = app.state.isListening ? 'üî¥' : 'üé§';
                },

                showLiveCaption: app.utils.debounce((text, type = 'bot') => {
                    const captionsDiv = app.utils.$('live-captions');
                    captionsDiv.textContent = text;
                    captionsDiv.className = `live-captions ${type}-caption`;
                    captionsDiv.classList.remove('hidden');
                }, 100),

                showReadingWordPrompt(prompt, word) {
                    const existing = app.utils.$('reading-word-prompt');
                    if (existing) existing.remove();

                    const container = document.createElement('div');
                    container.id = 'reading-word-prompt';
                    container.className = 'reading-prompt';
                    container.innerHTML = `
                        <div style="font-size: 1.4rem; font-weight: 600;">${prompt}</div>
                        <div class="reading-word">${word}</div>
                    `;

                    app.utils.$('tutor-interface').insertBefore(container, app.utils.$('tutor-interface').children[2]);
                },

                removeReadingPrompt() {
                    const existing = app.utils.$('reading-word-prompt');
                    if (existing) existing.remove();
                }
            },

            // API communication with improved error handling
            api: {
                async request(endpoint, options = {}) {
                    const url = `${app.config.API_BASE_URL}${endpoint}`;
                    const defaultOptions = {
                        headers: { 'Content-Type': 'application/json' },
                        timeout: 15000
                    };

                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), options.timeout || defaultOptions.timeout);

                        const response = await fetch(url, {
                            ...defaultOptions,
                            ...options,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        return await response.json();
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            throw new Error('Request timeout - please check your connection');
                        }
                        throw error;
                    }
                },

                async startSession(studentData) {
                    return await this.request('/session/start', {
                        method: 'POST',
                        body: JSON.stringify(studentData)
                    });
                },

                async sendMessage(sessionId, message) {
                    return await this.request('/chat', {
                        method: 'POST',
                        body: JSON.stringify({
                            sessionId,
                            message,
                            context: {}
                        })
                    });
                },

                async endSession(sessionId) {
                    try {
                        const [summaryResponse] = await Promise.allSettled([
                            this.request(`/session/${sessionId}/summary`),
                            this.request(`/session/${sessionId}/end`, { method: 'POST' })
                        ]);

                        return summaryResponse.status === 'fulfilled' ? summaryResponse.value : null;
                    } catch (error) {
                        console.error('Session end error:', error);
                        return null;
                    }
                }
            },

            // Notes functionality
            notes: {
                state: {
                    isDrawing: false,
                    isTextMode: false,
                    currentColor: '#000',
                    brushSize: 3,
                    canvas: null,
                    ctx: null
                },

                init() {
                    const canvas = app.utils.$('notes-canvas');
                    const container = canvas.parentElement;
                    
                    // Set canvas size
                    const rect = container.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = Math.max(300, rect.height);
                    
                    this.state.canvas = canvas;
                    this.state.ctx = canvas.getContext('2d');
                    
                    // Mouse events
                    canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                    canvas.addEventListener('mousemove', this.draw.bind(this));
                    canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                    canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                    
                    // Touch events
                    canvas.addEventListener('touchstart', this.handleTouch.bind(this));
                    canvas.addEventListener('touchmove', this.handleTouch.bind(this));
                    canvas.addEventListener('touchend', this.stopDrawing.bind(this));
                    
                    // Prevent scrolling when drawing
                    canvas.addEventListener('touchstart', e => e.preventDefault());
                    canvas.addEventListener('touchmove', e => e.preventDefault());
                },

                getEventPos(e) {
                    const rect = this.state.canvas.getBoundingClientRect();
                    const scaleX = this.state.canvas.width / rect.width;
                    const scaleY = this.state.canvas.height / rect.height;
                    
                    return {
                        x: (e.clientX - rect.left) * scaleX,
                        y: (e.clientY - rect.top) * scaleY
                    };
                },

                startDrawing(e) {
                    if (this.state.isTextMode) return;
                    
                    this.state.isDrawing = true;
                    const pos = this.getEventPos(e);
                    
                    this.state.ctx.beginPath();
                    this.state.ctx.moveTo(pos.x, pos.y);
                },

                draw(e) {
                    if (!this.state.isDrawing || this.state.isTextMode) return;
                    
                    const pos = this.getEventPos(e);
                    
                    this.state.ctx.lineWidth = this.state.brushSize;
                    this.state.ctx.lineCap = 'round';
                    this.state.ctx.strokeStyle = this.state.currentColor;
                    
                    this.state.ctx.lineTo(pos.x, pos.y);
                    this.state.ctx.stroke();
                    this.state.ctx.beginPath();
                    this.state.ctx.moveTo(pos.x, pos.y);
                },

                stopDrawing() {
                    this.state.isDrawing = false;
                    this.state.ctx.beginPath();
                },

                handleTouch(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    if (!touch) return;
                    
                    const mouseEvent = new MouseEvent(
                        e.type === 'touchstart' ? 'mousedown' : 
                        e.type === 'touchmove' ? 'mousemove' : 'mouseup', 
                        {
                            clientX: touch.clientX,
                            clientY: touch.clientY
                        }
                    );
                    this.state.canvas.dispatchEvent(mouseEvent);
                },

                switchToText() {
                    this.state.isTextMode = true;
                    app.utils.$('text-tool').classList.add('active');
                    app.utils.$('draw-tool').classList.remove('active');
                    app.utils.$('notes-text').style.display = 'block';
                    app.utils.$('notes-canvas').style.display = 'none';
                },

                switchToDraw() {
                    this.state.isTextMode = false;
                    app.utils.$('draw-tool').classList.add('active');
                    app.utils.$('text-tool').classList.remove('active');
                    app.utils.$('notes-text').style.display = 'none';
                    app.utils.$('notes-canvas').style.display = 'block';
                    
                    if (!this.state.canvas) {
                        setTimeout(() => this.init(), 100);
                    }
                },

                setColor(color) {
                    this.state.currentColor = color;
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                    document.querySelector(`[data-color="${color}"]`).classList.add('active');
                },

                setBrushSize(size) {
                    this.state.brushSize = parseInt(size);
                },

                clear() {
                    if (this.state.isTextMode) {
                        app.utils.$('notes-text').value = '';
                    } else if (this.state.ctx) {
                        this.state.ctx.clearRect(0, 0, this.state.canvas.width, this.state.canvas.height);
                    }
                }
            },

            // Main application methods
            async startTutoring() {
                try {
                    app.utils.updateStatus("Initializing...", 'processing');
                    
                    await app.speech.init();
                    
                    if (!app.recognition.init()) {
                        app.utils.showError('Speech recognition not supported. Please use a compatible browser.');
                        return;
                    }

                    const studentName = app.utils.$('student-name').value.trim();
                    const studentGrade = app.utils.$('student-grade').value;

                    app.utils.updateStatus("Starting your session...", 'processing');
                    
                    const data = await app.api.startSession({
                        studentName: studentName || 'Student',
                        grade: studentGrade || 'K',
                        subjects: []
                    });

                    app.state.currentSessionId = data.sessionId;
                    app.state.sessionStarted = true;
                    app.state.connectionRetries = 0;
                    
                    app.utils.$('welcome-screen').classList.add('hidden');
                    app.utils.$('tutor-interface').classList.remove('hidden');
                    
                    // Initialize canvas after interface is shown
                    setTimeout(() => app.notes.init(), 100);
                    
                    const welcomeMessage = data.welcomeMessage || 
                        `Hi ${studentName || 'there'}! I'm your AI tutor and I'm excited to learn with you today. What would you like to explore?`;
                    
                    await app.speech.speak(welcomeMessage);
                    app.utils.addToConversation('tutor', welcomeMessage);
                    app.utils.updateStatus("Press the microphone to start talking!");

                } catch (error) {
                    console.error('Error starting session:', error);
                    app.utils.showError(`Failed to start session: ${error.message}`);
                }
            },

            async handleUserInput(input) {
                if (app.state.isProcessing || !app.state.sessionStarted) return;

                app.state.isProcessing = true;
                app.utils.updateStatus("Processing your request...", 'processing');

                app.utils.addToConversation('user', input);
                app.state.conversationContext.push({ role: 'user', content: input });

                try {
                    const data = await app.api.sendMessage(app.state.currentSessionId, input);
                    const tutorResponse = data.response;

                    // Handle reading word display
                    if (!data.readingWord) {
                        app.ui.removeReadingPrompt();
                    }

                    if (data.readingWord) {
                        app.ui.showReadingWordPrompt(tutorResponse, data.readingWord);
                        await app.speech.speak(tutorResponse);
                        app.utils.addToConversation('tutor', tutorResponse + ' (See word above)');
                    } else {
                        await app.speech.speak(tutorResponse);
                        app.utils.addToConversation('tutor', tutorResponse);
                    }

                    app.state.conversationContext.push({ role: 'assistant', content: tutorResponse });
                    if (data.subject) app.state.currentSubject = data.subject;
                    
                    app.state.connectionRetries = 0; // Reset on success

                } catch (error) {
                    console.error('Error getting response:', error);
                    
                    // Retry logic for connection issues
                    if (app.state.connectionRetries < app.config.maxRetries && 
                        (error.message.includes('timeout') || error.message.includes('network'))) {
                        
                        app.state.connectionRetries++;
                        app.utils.updateStatus(`Connection issue. Retrying... (${app.state.connectionRetries}/${app.config.maxRetries})`, 'processing');
                        
                        setTimeout(() => app.handleUserInput(input), 2000);
                        return;
                    }
                    
                    // Fallback response
                    const fallbackResponse = app.generateFallbackResponse(input);
                    app.utils.addToConversation('tutor', fallbackResponse);
                    await app.speech.speak(fallbackResponse);
                    
                } finally {
                    app.state.isProcessing = false;
                    app.utils.updateStatus("Press the microphone to continue our conversation!");
                }
            },

            generateFallbackResponse(input) {
                const responses = {
                    math: "I love math! Let's work on this together. What specific math topic would you like to practice?",
                    read: "Reading is so much fun! What kind of stories or books do you enjoy?",
                    science: "Science is amazing! There's so much to discover. What interests you most?",
                    animal: "Animals are fascinating! Do you have a favorite animal you'd like to learn about?",
                    color: "Colors are everywhere! What's your favorite color and why?",
                    number: "Numbers are really useful! Let's explore some fun number games.",
                    story: "I love stories! Would you like to hear one or create one together?",
                    game: "Learning games are the best! What kind of educational game sounds fun to you?"
                };
                
                const key = Object.keys(responses).find(k => input.toLowerCase().includes(k));
                return responses[key] || "That sounds really interesting! Can you tell me more about what you're thinking? I'm here to help you learn!";
            },

            toggleListening() {
                if (app.state.isListening) {
                    app.recognition.stop();
                } else {
                    app.recognition.start();
                }
            },

            showHistory() {
                app.utils.$('full-chat-history').innerHTML = app.state.chatHistory.map(msg =>
                    `<div class="chat-message ${msg.sender}-message">
                        <strong>${msg.sender === 'tutor' ? 'Tutor' : 'You'}:</strong> ${msg.message}
                    </div>`
                ).join('');
                app.utils.$('chat-history-modal').classList.remove('hidden');
            },

            closeHistory() {
                app.utils.$('chat-history-modal').classList.add('hidden');
            },

            async endSession() {
                app.state.speechSynthesis.cancel();
                app.recognition.stop();
                
                try {
                    const summary = await app.api.endSession(app.state.currentSessionId);
                    app.showSessionSummary(summary);
                } catch (error) {
                    console.error('Error ending session:', error);
                    app.showSessionSummary(null);
                }
            },

            async showSessionSummary(summary) {
                app.utils.$('tutor-interface').classList.add('hidden');
                app.utils.$('session-summary').classList.remove('hidden');
                
                const summaryContent = app.utils.$('summary-content');
                
                if (summary) {
                    const allSuggestions = [
                        ...(Array.isArray(summary.suggestions) ? summary.suggestions : [summary.suggestions]),
                        ...(Array.isArray(summary.nextSteps) ? summary.nextSteps : [summary.nextSteps])
                    ].filter(Boolean);

                    summaryContent.innerHTML = `
                        <div class="summary-item"><strong>Duration:</strong> ${summary.duration || 'Great session!'}</div>
                        <div class="summary-item"><strong>Topics Explored:</strong> ${summary.topicsExplored || 'Various interesting topics!'}</div>
                        <div class="summary-item"><strong>Learning Highlights:</strong><br>${(summary.highlights || ['Great participation!']).join('<br>')}</div>
                        <div class="summary-item"><strong>Next Steps:</strong><br>${allSuggestions.length ? allSuggestions.join('<br>') : 'Keep asking great questions!'}</div>
                    `;
                } else {
                    summaryContent.innerHTML = `
                        <div class="summary-item"><strong>Session Complete!</strong> You had a wonderful learning session today!</div>
                        <div class="summary-item"><strong>Keep Learning:</strong> Continue exploring topics that spark your curiosity!</div>
                    `;
                }
                
                await app.speech.speak("You had a wonderful learning session today! Keep being curious and asking great questions.");
            },

            startNewSession() {
                app.state.speechSynthesis.cancel();
                
                // Reset state
                Object.assign(app.state, {
                    currentSessionId: null,
                    isProcessing: false,
                    sessionStarted: false,
                    isListening: false,
                    conversationContext: [],
                    chatHistory: [],
                    currentSubject: null,
                    connectionRetries: 0
                });
                
                // Reset UI
                app.utils.$('session-summary').classList.add('hidden');
                app.utils.$('welcome-screen').classList.remove('hidden');
                app.utils.$('student-name').value = '';
                app.utils.$('student-grade').value = '';
                app.ui.removeReadingPrompt();
                
                app.ui.updateMicButton();
                app.utils.updateStatus("Ready to start a new session!");
            }
        };

        // Event listeners for window focus/blur
        window.addEventListener('blur', () => {
            if (app.state.isListening) app.recognition.stop();
        });

        window.addEventListener('focus', () => {
            if (app.state.sessionStarted && !app.state.isProcessing) {
                app.utils.updateStatus("Press the microphone to continue our conversation!");
            }
        });

        // Responsive canvas resize
        window.addEventListener('resize', app.utils.debounce(() => {
            if (app.notes.state.canvas) {
                app.notes.init();
            }
        }, 250));

        // Initialize app when page loads
        window.addEventListener('load', async () => {
            console.log('üöÄ AI Tutor loading...');
            try {
                await app.speech.init();
                console.log('‚úÖ App loaded successfully');
            } catch (error) {
                console.error('‚ùå App initialization error:', error);
            }
        });

        // Prevent accidental page refresh during sessions
        window.addEventListener('beforeunload', (e) => {
            if (app.state.sessionStarted) {
                e.preventDefault();
                e.returnValue = 'You have an active learning session. Are you sure you want to leave?';
            }
        });

        // Global function wrappers for onclick handlers
        function startTutoring() { return app.startTutoring(); }
        function toggleListening() { return app.toggleListening(); }
        function endSession() { return app.endSession(); }
        function startNewSession() { return app.startNewSession(); }
        function closeHistory() { return app.closeHistory(); }
        function switchToText() { return app.notes.switchToText(); }
        function switchToDraw() { return app.notes.switchToDraw(); }
        function clearNotes() { return app.notes.clear(); }
        function setColor(color) { return app.notes.setColor(color); }
        function setBrushSize(size) { return app.notes.setBrushSize(size); }
    </script>
</body>
</html>